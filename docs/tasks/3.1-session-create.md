# タスク詳細: 3.1 session_create ツール実装

## 概要

生成AIがJupyter環境でコードを実行するためのセッション（カーネル）を作成するMCPツールを実装する。

このタスクは Phase 3「セッション・カーネル管理」の最初のタスクであり、コード実行（Phase 4）の前提となる重要な機能である。

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「F1.1: セッション作成」「MCPツール定義 > session_create」
- API仕様: `docs/design/api-contracts.md` の「POST /api/kernels」
- Skill: `.claude/skills/mcp-typescript-server/SKILL.md`

## 現状分析

### 既存実装

- `jupyter-client` にはすでに `createKernel()` メソッドが実装済み
- ツール登録の仕組み（`tools/index.ts`）が確立済み
- レスポンスフォーマッターが利用可能

### 不足している部分

- `session_create` ツールの定義（スキーマ）
- ツール実行関数（`executeSessionCreate`）
- ツール登録・ルーティングの追加

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/src/tools/session-create.ts` | session_create ツールの実装 |

### 修正するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/src/tools/index.ts` | ツール定義の追加、ルーティングの追加 |

### 実装手順

#### 1. ツール実装ファイルの作成

`jupyter-mcp/src/tools/session-create.ts` を作成する。

**入力パラメータ:**
- `name` (optional): セッション名（デフォルト: python3）
- `notebook_path` (optional): 関連付けるノートブックのパス（タスク 3.6 で使用、今回は未実装でも可）

**出力:**
```json
{
  "success": true,
  "session_id": "abc123",
  "kernel_id": "kernel-xyz",
  "status": "idle",
  "created_at": "2024-01-15T10:00:00Z"
}
```

**注意点:**
- 現状の API 仕様では、カーネル作成 API が「セッション」ではなく「カーネル」として設計されている
- `session_id` と `kernel_id` は同一の値を使用する（Jupyter の Sessions API を今後使う場合は分離）

#### 2. ツール定義の追加

`jupyter-mcp/src/tools/index.ts` に以下を追加：

```typescript
{
  name: "session_create",
  description: "新しいデータ分析セッションを作成します。コード実行前に必ず呼び出してください。",
  inputSchema: {
    type: "object",
    properties: {
      name: {
        type: "string",
        description: "カーネル名（デフォルト: python3）",
      },
      notebook_path: {
        type: "string",
        description: "関連付けるノートブックのパス。指定するとユーザーがそのノートブックを開いたときに同じカーネルを共有できる（現在未実装）",
      },
    },
    required: [],
  },
}
```

#### 3. ルーティングの追加

`handleToolCall` に `session_create` ケースを追加。

### 技術的な考慮事項

#### セッション概念の設計

要件定義では「セッション」という概念を使用しているが、Jupyter Server API には以下の2種類がある：

1. **Kernels API** (`/api/kernels`): カーネルの直接管理
2. **Sessions API** (`/api/sessions`): ノートブックとカーネルの紐付け管理

今回の実装では：
- 内部的には Kernels API を使用
- MCP ツールとしては「セッション」という抽象概念で提供
- `session_id` = `kernel_id` として扱う

この設計により、将来的に Sessions API への移行も可能になる。

#### notebook_path パラメータ

タスク 3.6「session_create のnotebook_path対応」で本格実装するため、今回は以下の方針：
- パラメータは受け取る（スキーマに含める）
- 実際の処理は行わない（警告メッセージを出力）
- レスポンスには含めない

#### エラーハンドリング

既存の `JupyterClientError` を活用し、以下のエラーケースに対応：
- 接続エラー（jupyter-server が起動していない）
- 認証エラー（トークン不正）
- カーネル起動失敗

## 完了条件

- [x] `session_create` ツールが MCP ツール一覧に表示される
- [x] ツール実行でカーネルが起動する
- [x] レスポンスに `session_id`, `kernel_id`, `status`, `created_at` が含まれる
- [x] 起動したカーネルが `listKernels` で確認できる
- [x] エラー時に適切なエラーレスポンスが返る
- [x] 既存のテスト・ビルドが通る

## テスト計画

### 手動テスト

1. **MCP Inspector でのテスト**
   ```bash
   cd jupyter-mcp
   npm run build
   npx @modelcontextprotocol/inspector node dist/index.js
   ```
   - ツール一覧に `session_create` が表示されることを確認
   - ツールを実行してレスポンスを確認

2. **jupyter-server との結合テスト**
   ```bash
   # jupyter-server を起動
   cd jupyter-server && docker-compose up -d

   # カーネルが作成されることを確認
   curl http://localhost:8888/api/kernels \
     -H "Authorization: Bearer ${JUPYTER_TOKEN}"
   ```

### 確認項目

| テストケース | 期待結果 |
|-------------|----------|
| パラメータなしで実行 | python3 カーネルが起動 |
| `name: "python3"` で実行 | python3 カーネルが起動 |
| jupyter-server 停止中に実行 | 接続エラーが返る |

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
