# タスク詳細: 6.2 ファイル操作の結合テスト

## 概要

Phase 6（ファイル操作）の結合テストを実装する。ノートブック作成後に`file_list`ツールでファイルの存在を確認する一連のワークフローをテストする。

タスク 6.1 で実装した `file_list` ツールを、実際の分析ワークフロー（ノートブック作成→ファイル確認）の中で検証する。

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「F5: ファイル操作」セクション（F5.1 ファイル一覧）
- API仕様: `docs/design/api-contracts.md` の「GET /api/contents」セクション
- 既存テスト: `jupyter-mcp/tests/integration/notebook.test.ts`（ノートブック操作の参考）
- 関連タスク: `docs/tasks/6.1-file-list-tool.md`（file_list ツール実装）

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/tests/integration/file-list.test.ts` | ファイル操作の結合テスト |

### 実装手順

1. 新規テストファイル `file-list.test.ts` を作成
2. 以下のテストケースを実装:
   - **ノートブック作成→file_list で確認**: ノートブック作成後、file_list で新規ファイルが一覧に含まれることを確認
   - **ルートディレクトリ一覧取得**: デフォルト（path 省略）でルートディレクトリの内容が取得できる
   - **ディレクトリ内ファイル一覧**: サブディレクトリを指定してファイル一覧が取得できる
   - **ファイル種別の確認**: notebook、file、directory が正しく区別される
   - **エラーケース**: パストラバーサル攻撃、存在しないパス

### テストケース詳細

#### ワークフローテスト

```typescript
describe('ファイル操作の結合テスト', () => {
  test('ノートブック作成 → file_list で確認', async () => {
    // 1. ノートブック作成
    // 2. file_list でルートディレクトリのファイル一覧を取得
    // 3. 作成したノートブックが一覧に含まれることを確認
    // 4. type が "notebook" であることを確認
  });

  test('ルートディレクトリのファイル一覧を取得（path 省略）', async () => {
    // 1. セッション作成
    // 2. file_list(session_id, path=undefined) を呼び出し
    // 3. contents 配列が返ることを確認
    // 4. path が "/" であることを確認
  });

  test('ルートディレクトリのファイル一覧を取得（path="/"）', async () => {
    // 1. セッション作成
    // 2. file_list(session_id, path="/") を呼び出し
    // 3. contents 配列が返ることを確認
  });

  test('file_list のレスポンス形式を確認', async () => {
    // 1. ノートブック作成
    // 2. file_list 呼び出し
    // 3. 各ファイルエントリに name, type, size, modified_at が含まれることを確認
  });

  test('複数ノートブック作成 → file_list で全て確認', async () => {
    // 1. ノートブック A, B, C を作成
    // 2. file_list でルートディレクトリを取得
    // 3. A, B, C すべてが一覧に含まれることを確認
  });
});
```

#### エラーハンドリングテスト

```typescript
describe('file_list エラーハンドリング', () => {
  test('パストラバーサル攻撃を拒否', async () => {
    // 1. セッション作成
    // 2. file_list(session_id, path="../etc/passwd") を呼び出し
    // 3. VALIDATION_ERROR エラーを確認
  });

  test('存在しないパスを指定 → エラー', async () => {
    // 1. セッション作成
    // 2. file_list(session_id, path="nonexistent-directory") を呼び出し
    // 3. NOT_FOUND エラーを確認
  });

  test('session_id が未指定 → VALIDATION_ERROR', async () => {
    // 1. file_list(session_id=undefined) を呼び出し
    // 2. VALIDATION_ERROR エラーを確認
  });
});
```

### 技術的な考慮事項

- 既存の `tests/setup.ts` のヘルパー関数（`generateTestNotebookName`, `cleanupNotebook`, `checkJupyterConnection`, `parseToolCallResult`）を再利用
- `notebook.test.ts` と同様のパターンで beforeAll/afterEach を設定
- テスト間でノートブックを適切にクリーンアップ
- `session_id` は実際のセッションを作成せず、ダミー値を使用（file_list は内部でセッションを使用しないため）

**session_id について:**
- `file_list` の実装では `session_id` を検証するが、実際の API 呼び出しには使用しない
- テストでは任意の文字列（例: `"test-session-for-file-list"`）を使用可能
- ただし、統一性のためにセッション作成を行うことも選択肢として有効

## 完了条件

- [x] `jupyter-mcp/tests/integration/file-list.test.ts` が作成されている
- [x] すべてのテストケースが `npm test` で PASS する
- [x] ノートブック作成→file_list で確認の一連フローが動作することが検証されている
- [x] パストラバーサル攻撃が拒否されることが検証されている
- [x] 存在しないパスで適切なエラーが返ることが検証されている

## テスト計画

```bash
# 結合テストの実行（要 jupyter-server 起動）
cd jupyter-mcp
docker-compose up -d  # jupyter-server 起動
npm test -- tests/integration/file-list.test.ts
```

### テスト実行の前提条件

- `jupyter-server` が起動していること
- 環境変数 `JUPYTER_SERVER_URL`, `JUPYTER_TOKEN` が設定されていること

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
