# タスク詳細: 5.3 変数管理の結合テスト

## 概要

Phase 5（変数管理）の結合テストを実装する。コード実行後に`get_variables`と`get_dataframe_info`を使って変数状態を確認する一連のワークフローをテストする。

既に`get-variables.test.ts`が存在するが、これは`get_variables`ツール単体のテストが中心。本タスクでは、以下のような「コード実行→変数確認」という実際の分析フローをシミュレートした結合テストを追加する。

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「F4: 変数・データ操作」セクション
- 既存テスト: `jupyter-mcp/tests/integration/get-variables.test.ts`
- 既存テスト: `jupyter-mcp/tests/integration/execute-code.test.ts`（ワークフローテストの参考）

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/tests/integration/variables-workflow.test.ts` | 変数管理の結合テスト |

### 実装手順

1. 新規テストファイル `variables-workflow.test.ts` を作成
2. 以下のテストケースを実装:
   - **データ読み込み→変数確認フロー**: pandas でデータを読み込み、`get_variables` で DataFrame が認識されることを確認
   - **get_dataframe_info の統合テスト**: DataFrame 作成後に詳細情報（shape, columns, dtypes, head, describe）を取得
   - **複数変数の追跡テスト**: 複数のコードセルを実行し、変数が累積して保持されることを確認
   - **変数の上書きテスト**: 同じ変数名を再定義した場合の動作確認
   - **エラーケース**: 存在しない変数名での `get_dataframe_info` 呼び出し

### テストケース詳細

#### ワークフローテスト

```typescript
describe('変数管理のワークフローテスト', () => {
  test('データ読み込み → get_variables で DataFrame を確認', async () => {
    // 1. セッション作成
    // 2. pandas インポート & CSV データ模擬
    // 3. get_variables で変数一覧取得
    // 4. DataFrame 変数が含まれていることを確認
  });

  test('DataFrame 作成 → get_dataframe_info で詳細情報取得', async () => {
    // 1. セッション作成
    // 2. DataFrame 作成（カラム名、型、サンプルデータ定義）
    // 3. get_dataframe_info を呼び出し
    // 4. shape, columns, dtypes, head, describe を検証
  });

  test('複数コード実行 → 変数が累積して保持される', async () => {
    // 1. セッション作成
    // 2. x = 10 実行
    // 3. y = 20 実行
    // 4. z = x + y 実行
    // 5. get_variables で x, y, z すべて存在確認
    // 6. z の値が 30 であることを確認
  });

  test('変数の上書き → 新しい値に更新される', async () => {
    // 1. セッション作成
    // 2. x = 100 実行
    // 3. x = 200 実行
    // 4. get_variables で x = 200 を確認
  });

  test('分析シナリオ: インポート → データ作成 → 変換 → 集計', async () => {
    // 1. セッション作成
    // 2. pandas, numpy インポート
    // 3. DataFrame 作成
    // 4. 列追加（df['new_col'] = ...）
    // 5. グループ集計（df.groupby().sum()）
    // 6. 各ステップで get_variables を呼び、変数状態を確認
  });
});
```

#### エラーハンドリングテスト

```typescript
describe('get_dataframe_info エラーハンドリング', () => {
  test('存在しない変数名を指定 → NOT_FOUND エラー', async () => {
    // 1. セッション作成
    // 2. get_dataframe_info('non_existent_var')
    // 3. エラーレスポンス確認
  });

  test('DataFrame 以外の変数を指定 → INVALID_VARIABLE_TYPE エラー', async () => {
    // 1. セッション作成
    // 2. x = 42 実行
    // 3. get_dataframe_info('x')
    // 4. INVALID_VARIABLE_TYPE エラーを確認
  });
});
```

### 技術的な考慮事項

- 既存の `tests/setup.ts` のヘルパー関数を再利用
- テスト間でセッション・ノートブックを適切にクリーンアップ
- タイムアウト設定は既存テストに合わせる（10秒程度）
- `get-variables.test.ts` とテストケースが重複しないよう注意

## 完了条件

- [x] `jupyter-mcp/tests/integration/variables-workflow.test.ts` が作成されている
- [x] すべてのテストケースが `npm test` で PASS する
- [x] コード実行→変数確認の一連フローが動作することが検証されている
- [x] `get_dataframe_info` で DataFrame 詳細情報が正しく取得できる
- [x] エラーケース（存在しない変数、DataFrame 以外）が適切に処理される

## テスト計画

```bash
# 結合テストの実行（要 jupyter-server 起動）
cd jupyter-mcp
docker-compose up -d  # jupyter-server 起動
npm test -- tests/integration/variables-workflow.test.ts
```

### テスト実行の前提条件

- `jupyter-server` が起動していること
- 環境変数 `JUPYTER_SERVER_URL`, `JUPYTER_TOKEN` が設定されていること

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
