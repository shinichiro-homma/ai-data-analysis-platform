# タスク詳細: 8.1 単体テスト整備

## 概要

jupyter-mcp の各ツールに対する単体テスト（ユニットテスト）を実装する。

現在、`tests/integration/` に結合テストが存在するが、これらは Jupyter サーバーの起動を前提としている。単体テストを追加することで、Jupyter サーバーなしでも高速にテストを実行でき、CI/CD での自動テストやリファクタリング時の回帰テストが容易になる。

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「MCPツール定義」「受け入れ条件」セクション
- 設計: `jupyter-mcp/CLAUDE.md` のツール一覧
- Skill: `.claude/skills/mcp-typescript-server/SKILL.md`

## 現状分析

### 既存テスト構成

```
tests/
├── setup.ts                  # ヘルパー関数（Jupyter接続前提）
├── helpers/
│   └── mcp-client.ts         # MCPクライアントヘルパー
└── integration/              # 結合テスト（11ファイル）
    ├── session.test.ts
    ├── session-connect.test.ts
    ├── session-create-notebook-path.test.ts
    ├── notebook.test.ts
    ├── execute-code.test.ts
    ├── execute-code-images.test.ts
    ├── get-variables.test.ts
    ├── variables-workflow.test.ts
    ├── file-list.test.ts
    ├── get-image-resource.test.ts
    └── image-workflow.test.ts
```

### テスト対象モジュール

**ツール実装（src/tools/）:**
| ファイル | テスト対象 |
|----------|-----------|
| session-create.ts | セッション作成ロジック |
| session-list.ts | セッション一覧取得ロジック |
| session-delete.ts | セッション削除ロジック |
| session-connect.ts | 既存セッション接続ロジック |
| execute-code.ts | コード実行ロジック |
| get-variables.ts | 変数一覧取得ロジック |
| get-dataframe-info.ts | DataFrame情報取得ロジック |
| notebook-create.ts | ノートブック作成ロジック |
| notebook-add-cell.ts | セル追加ロジック |
| file-list.ts | ファイル一覧取得ロジック |
| get-image-resource.ts | 画像リソース取得ロジック |
| index.ts | ツールルーティング |

**ユーティリティ（src/utils/）:**
| ファイル | テスト対象 |
|----------|-----------|
| validation.ts | 入力バリデーション |
| path-validator.ts | パス検証 |
| response-formatter.ts | レスポンス整形 |
| session-formatter.ts | セッション情報整形 |
| session-resolver.ts | セッション解決 |

**画像ストア（src/image-store/）:**
| ファイル | テスト対象 |
|----------|-----------|
| uri-utils.ts | URI生成・パース |
| index.ts | 画像ストア操作 |

**Jupyterクライアント（src/jupyter-client/）:**
| ファイル | テスト対象 |
|----------|-----------|
| client.ts | APIクライアント（モックテスト）|
| errors.ts | エラークラス |

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `tests/unit/utils/validation.test.ts` | validateStringParameter のテスト |
| `tests/unit/utils/path-validator.test.ts` | パス検証のテスト |
| `tests/unit/image-store/uri-utils.test.ts` | URI生成・パースのテスト |
| `tests/unit/image-store/image-store.test.ts` | 画像ストア操作のテスト |
| `tests/unit/tools/index.test.ts` | ツールルーティングのテスト |
| `tests/unit/jupyter-client/errors.test.ts` | エラークラスのテスト |
| `tests/unit/tools/session-create.test.ts` | session_create のモックテスト |
| `tests/unit/tools/execute-code.test.ts` | execute_code のモックテスト |
| `vitest.config.unit.ts` | 単体テスト用vitest設定 |

### 実装手順

1. **vitest 設定ファイル追加**
   - `vitest.config.unit.ts` を作成
   - `tests/unit/**/*.test.ts` を対象に設定
   - package.json に `test:unit` スクリプト追加

2. **ユーティリティの単体テスト作成**
   - `validation.ts` - 各バリデーション条件のテスト
   - `path-validator.ts` - 正常系・異常系のパステスト
   - `uri-utils.ts` - URI生成・パースのテスト

3. **画像ストアの単体テスト作成**
   - `image-store/index.ts` - 画像の保存・取得・削除のテスト
   - インメモリストアなのでモック不要

4. **エラークラスの単体テスト作成**
   - JupyterClientError のプロパティ検証
   - エラーコード・ステータスコードの検証

5. **ツールルーティングの単体テスト作成**
   - 各ツール名でのルーティング確認
   - 存在しないツール名のエラー確認

6. **モックを使ったツールのテスト作成**
   - vitest の `vi.mock()` で `jupyterClient` をモック
   - 正常系・エラー系のレスポンス検証

### 技術的な考慮事項

**モック戦略:**
- `jupyterClient` は外部API（Jupyter Server）に依存するため、モック化が必要
- vitest の `vi.mock()` と `vi.fn()` を使用
- モックはテストファイルごとに個別設定（影響範囲を限定）

**テストカバレッジ:**
- 各ツールの正常系・エラー系を網羅
- バリデーションエラー、APIエラー、タイムアウトをテスト
- 境界値テスト（空文字、長すぎる文字列、特殊文字等）

**テスト命名規則:**
```typescript
describe('関数名', () => {
  test('条件 => 期待結果', () => {
    // ...
  });
});
```

## 完了条件

- [x] `vitest.config.unit.ts` が作成されている
- [x] package.json に `test:unit` スクリプトが追加されている
- [x] `npm run test:unit` が正常に実行される
- [x] ユーティリティ関数（validation, path-validator, uri-utils）の単体テストが存在する
- [x] 画像ストアの単体テストが存在する
- [x] エラークラスの単体テストが存在する
- [x] ツールルーティングの単体テストが存在する
- [x] 少なくとも2つのツール（session_create, execute_code）のモックテストが存在する
- [x] すべての単体テストが通る

## テスト計画

### テスト実行方法

```bash
# 単体テストのみ実行
npm run test:unit

# 結合テストのみ実行（Jupyterサーバー必要）
npm run test:integration

# 全テスト実行
npm test
```

### テストケース例

**validation.ts のテスト:**
```typescript
describe('validateStringParameter', () => {
  test('有効な文字列 => isValid: true');
  test('必須フィールドが未指定 => isValid: false');
  test('空文字列 => isValid: false');
  test('長すぎる文字列 => isValid: false');
  test('NULLバイトを含む => isValid: false');
});
```

**uri-utils.ts のテスト:**
```typescript
describe('buildResourceUri', () => {
  test('PNG画像のURI生成 => 正しいURI形式');
  test('JPEG画像のURI生成 => .jpg拡張子');
});

describe('extractImageIdFromUri', () => {
  test('有効なURI => 画像ID抽出');
  test('無効なURI => null');
});
```

**session_create のモックテスト:**
```typescript
describe('executeSessionCreate', () => {
  test('正常なカーネル作成 => success: true, session_id返却');
  test('APIエラー => success: false, エラー情報返却');
});
```

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
