# タスク詳細: 7.3 get_image_resource ツール実装

## 概要

execute_code で生成された画像を取得するための MCP ツール `get_image_resource` を実装する。

AI クライアントがリソース API（resources/read）を直接呼べない場合でも、このツールを使って画像データ（base64）を取得できるようにする。これにより AI がグラフ等の画像を認識し、内容を説明できるようになる。

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「F6.3: 画像リソース取得」セクション
- 要件定義: `docs/requirements/jupyter-mcp.md` の「get_image_resource ツール（補助）」セクション
- Skill: `.claude/skills/mcp-typescript-server/SKILL.md`

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/src/tools/get-image-resource.ts` | get_image_resource ツールの実装 |

### 修正するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/src/tools/index.ts` | ツール定義の追加、ルーティングの追加 |

### 実装手順

1. **ツール実装ファイルの作成** (`get-image-resource.ts`)
   - 既存のツール実装パターン（get-variables.ts 等）に従う
   - `imageStore.get(resource_uri)` で画像データを取得
   - 画像データを要件定義に合わせた形式で返却

2. **ツール定義の追加** (`index.ts`)
   - tools 配列に `get_image_resource` の定義を追加
   - handleToolCall に `get_image_resource` のルーティングを追加

### 技術的な考慮事項

- **既存の imageStore を活用**: 画像データは既に `image-store/index.ts` で管理されており、`resources/images.ts` の `readResource` と同様のロジックで取得可能
- **URI 形式の検証**: 不正な URI 形式の場合は適切なエラーメッセージを返す
- **画像が見つからない場合のエラー処理**: 存在しない画像IDを指定された場合は `NOT_FOUND` エラーを返す
- **レスポンス形式**: 要件定義に従い、`mime_type`, `data`, `width`, `height` を返す

### 入出力仕様

**入力（inputSchema）:**
```typescript
{
  type: "object",
  properties: {
    resource_uri: {
      type: "string",
      description: "画像のリソースURI（例: jupyter://sessions/abc123/images/output-001.png）"
    }
  },
  required: ["resource_uri"]
}
```

**出力:**
```json
{
  "mime_type": "image/png",
  "data": "iVBORw0KGgoAAAANSUhEUgAA...",
  "width": 800,
  "height": 600
}
```

**エラー時:**
```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "指定されたリソースURIの画像が見つかりません"
  }
}
```

## 完了条件

- [x] `get_image_resource` ツールが MCP ツール一覧に表示される
- [x] 有効な resource_uri を指定して画像データ（base64）が取得できる
- [x] 不正な resource_uri を指定するとバリデーションエラーが返る
- [x] 存在しない画像を指定すると NOT_FOUND エラーが返る
- [x] レスポンスに mime_type, data, width, height が含まれる

## テスト計画

### 手動テスト

1. MCP Inspector で `get_image_resource` ツールが表示されることを確認
2. 以下のフローで動作確認:
   - `session_create` でセッション作成
   - `execute_code` で matplotlib グラフを描画（例: `plt.plot([1,2,3]); plt.show()`）
   - レスポンスの `images[0].resource_uri` を取得
   - `get_image_resource` に上記 URI を渡して画像データを取得
3. 存在しない URI を指定してエラーが返ることを確認
4. 不正な形式の URI を指定してエラーが返ることを確認

### ユニットテスト（必要に応じて）

- `get-image-resource.test.ts` で以下をテスト:
  - 正常系: 有効な URI で画像取得
  - 異常系: URI 未指定
  - 異常系: 不正な URI 形式
  - 異常系: 存在しない画像 ID

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
