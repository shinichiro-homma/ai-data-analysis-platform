# タスク詳細: 2.1 notebook_create ツール実装

## 概要

新しいノートブックを作成するMCPツール `notebook_create` を実装する。

このタスクは、MCP サーバーの基盤構築（server.ts、ツール登録機構）と最初のツール実装を含む。Phase 2 の起点となるタスクであり、後続のツール実装（notebook_add_cell 等）の雛形となる。

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「F3.1: ノートブック作成」「MCPツール定義 > notebook_create」
- API仕様: `docs/design/api-contracts.md` の「POST /api/contents」
- Skill: `.claude/skills/mcp-typescript-server/SKILL.md`

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/src/server.ts` | MCPサーバー定義（新規） |
| `jupyter-mcp/src/tools/index.ts` | ツール登録と呼び出しルーティング（新規） |
| `jupyter-mcp/src/tools/notebook-create.ts` | notebook_create ツール実装（新規） |
| `jupyter-mcp/src/index.ts` | エントリーポイント更新（既存） |
| `jupyter-mcp/src/utils/errors.ts` | MCP用エラークラス（新規） |

### 実装手順

1. **MCP用エラー定義の作成** (`src/utils/errors.ts`)
   - ツール実行時のエラーを統一的に扱うためのクラスを定義

2. **MCPサーバーの基盤実装** (`src/server.ts`)
   - `@modelcontextprotocol/sdk` を使用
   - Server インスタンスの作成
   - capabilities の設定（tools）
   - ListToolsRequestSchema ハンドラ
   - CallToolRequestSchema ハンドラ

3. **ツール登録機構の実装** (`src/tools/index.ts`)
   - ツール定義の配列を管理
   - ツール名から実装関数へのルーティング
   - 共通のレスポンス形式を定義

4. **notebook_create ツールの実装** (`src/tools/notebook-create.ts`)
   - 入力スキーマの定義
   - JupyterClient.createNotebook() の呼び出し
   - 成功/エラーレスポンスの整形

5. **エントリーポイントの更新** (`src/index.ts`)
   - StdioServerTransport の設定
   - サーバーの起動処理

### 技術的な考慮事項

#### ツール定義について

要件定義では `notebook_create` に `session_id` が必須となっているが、実際の処理を確認すると：

- ノートブックの作成は Contents API (`POST /api/contents`) を使用
- この API はセッションやカーネルを必要としない（ファイルシステム操作のみ）
- セッションとノートブックの紐付けは Phase 3 の `session_create(notebook_path=...)` で行う

**判断:** `session_id` を不要とし、`name` (ノートブック名) と `path` (保存先ディレクトリ、オプション) のみを受け取る形式に変更する。これは要件定義の意図（ノートブック作成機能）を満たしつつ、より自然なAPIとなる。

```typescript
// 変更前（要件定義）
inputSchema: {
  required: ["session_id", "name"]
}

// 変更後（実装）
inputSchema: {
  required: ["name"],
  properties: {
    name: { type: "string", description: "ノートブック名（拡張子不要）" },
    path: { type: "string", description: "保存先ディレクトリ（省略時はルート）" }
  }
}
```

#### レスポンス形式

MCP SDK の戻り値形式に従い、以下の形式で返却する：

```typescript
{
  content: [
    {
      type: "text",
      text: JSON.stringify({
        success: true,
        path: "/analysis.ipynb",
        created_at: "2024-01-15T10:00:00Z"
      }, null, 2)
    }
  ]
}
```

#### エラーハンドリング

- JupyterClient のエラーをキャッチし、MCP 形式で返却
- 接続エラー、認証エラー、バリデーションエラーを適切に区別

## 完了条件

- [ ] `npm run build` が成功する
- [ ] `npm run typecheck` でエラーがない
- [ ] MCP Inspector で `notebook_create` ツールが表示される
- [ ] MCP Inspector でツールを実行し、ノートブックが作成される
- [ ] 作成されたノートブックが JupyterLab で開ける
- [ ] エラー時に適切なエラーメッセージが返る

## テスト計画

### 手動テスト（MCP Inspector）

1. **正常系: ノートブック作成**
   ```json
   {
     "name": "test-notebook"
   }
   ```
   - 期待結果: `test-notebook.ipynb` が作成される

2. **正常系: パス指定でノートブック作成**
   ```json
   {
     "name": "analysis",
     "path": "/work"
   }
   ```
   - 期待結果: `/work/analysis.ipynb` が作成される

3. **異常系: 必須パラメータなし**
   ```json
   {}
   ```
   - 期待結果: バリデーションエラー

4. **異常系: jupyter-server 未起動**
   - 期待結果: 接続エラーメッセージ

### E2Eテスト確認

```bash
# 1. jupyter-server 起動
cd jupyter-server && docker-compose up -d

# 2. jupyter-mcp ビルド・起動
cd jupyter-mcp && npm run build

# 3. MCP Inspector で確認
npx @modelcontextprotocol/inspector node dist/index.js
```

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
