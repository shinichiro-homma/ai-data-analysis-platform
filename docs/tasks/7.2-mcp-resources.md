# タスク詳細: 7.2 MCPリソース実装

## 概要

コード実行で生成された画像を MCP リソースとして公開し、`resources/list` と `resources/read` プロトコルメソッドで取得可能にする。

これにより、Claude 等の AI クライアントが画像を直接認識できる形式で取得でき、グラフや可視化結果を見て分析できるようになる。

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md`
  - 「F6: 画像出力（MCPリソース）」セクション
  - 「MCPリソース定義」セクション
  - 「AC5: 画像リソース」セクション
- スキル: `.claude/skills/mcp-typescript-server/SKILL.md`
  - 「リソースの実装」セクション

## 前提条件（タスク 7.1 で完了済み）

- `image-store/index.ts` - 画像データをインメモリで保存するストア
- `image-store/types.ts` - StoredImage、ImageReference 等の型定義
- `execute-code.ts` - 画像出力時に imageStore.store() を呼び出し、images 配列に resource_uri を含める

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `src/resources/images.ts` | 画像リソースのハンドラ実装（listResources, readResource） |

### 修正するファイル

| ファイル | 変更内容 |
|----------|----------|
| `src/server.ts` | capabilities に resources を追加、リソースハンドラを登録 |

### 実装手順

#### 1. image-store の拡張

imageStore に全画像一覧を取得するメソッドを追加する：

**listAll(): StoredImage[]**
- 全セッションの全画像を返す
- 内部の images Map から全て取得

#### 2. リソースハンドラの実装（`src/resources/images.ts`）

以下の関数を実装する：

**listResources(uriPrefix?: string)**
- imageStore.listAll() で全画像を取得
- uriPrefix が指定されている場合、その prefix で始まる URI の画像のみをフィルタ
  - 例: `jupyter://sessions/abc123/` を指定すると、そのセッションの画像のみ返却
  - 未指定の場合は全画像を返却（後方互換性のため）
- MCP Resource 形式に変換して返却
- 返却形式:
  ```typescript
  {
    resources: [
      {
        uri: "jupyter://sessions/{session_id}/images/{image_id}.png",
        name: "matplotlib output [1]",
        mimeType: "image/png",
        description: "matplotlib output [1]"
      },
      ...
    ]
  }
  ```

**readResource(uri: string)**
- URI から画像 ID を抽出
- imageStore.get() で画像データを取得
- MCP BlobResourceContents 形式で返却
- 返却形式:
  ```typescript
  {
    contents: [
      {
        uri: "jupyter://sessions/{session_id}/images/{image_id}.png",
        mimeType: "image/png",
        blob: "iVBORw0KGgoAAAANSUhEUgAA..."  // base64
      }
    ]
  }
  ```
- 画像が見つからない場合は適切なエラーを返す

#### 3. server.ts の修正

- capabilities に `resources: {}` を追加
- `ListResourcesRequestSchema` ハンドラを登録
- `ReadResourceRequestSchema` ハンドラを登録

```typescript
import {
  ListResourcesRequestSchema,
  ReadResourceRequestSchema,
} from "@modelcontextprotocol/sdk/types.js";
import { listResources, readResource } from "./resources/images.js";

// capabilities
{
  capabilities: {
    tools: {},
    resources: {},  // 追加
  },
}

// ハンドラ登録
server.setRequestHandler(ListResourcesRequestSchema, async (request) => {
  // MCP SDK の ListResourcesRequest は cursor パラメータを持つ
  // 独自拡張として _meta に uriPrefix を渡せるようにする（オプション）
  // または URI パターンでフィルタする標準的な方法がない場合は全件返却
  return listResources();
});

server.setRequestHandler(ReadResourceRequestSchema, async (request) => {
  return readResource(request.params.uri);
});
```

**注意:** MCP プロトコル標準では resources/list にフィルタパラメータがないため、以下の方式を採用：
- AI クライアントは execute_code の結果に含まれる resource_uri を使って resources/read を直接呼ぶ
- resources/list は主に MCP Inspector でのデバッグ用途
- 将来的に必要であれば、カスタムツール `list_session_images(session_id)` を追加可能

### 技術的な考慮事項

1. **URI prefix フィルタリング**
   - MCP プロトコル標準では resources/list にフィルタパラメータがない
   - 実用上は execute_code の結果から resource_uri を取得して resources/read を呼ぶフローが主
   - imageStore に listAll() を追加し、必要に応じてフィルタリングできる構造にしておく

2. **URI 形式の一貫性**
   - URI 形式は `jupyter://sessions/{session_id}/images/{image_id}.{ext}`
   - 既存の imageStore.store() が生成する URI 形式と一致させる

3. **エラーハンドリング**
   - 存在しない URI の場合は適切なエラーメッセージを返す
   - MCP エラー規約に従った形式にする

4. **MCP SDK の型**
   - `Resource` 型: uri, name, mimeType?, description? を含む
   - `BlobResourceContents` 型: uri, mimeType, blob を含む

## 完了条件

- [ ] imageStore に `listAll()` メソッドが追加される
- [ ] `resources/list` リクエストで、全画像がリスト形式で返却される
- [ ] `resources/read` リクエストで、指定 URI の画像データが base64 形式で返却される
- [ ] 存在しない URI を指定した場合、適切なエラーが返却される
- [ ] MCP Inspector で resources が表示される
- [ ] execute_code の結果から得た resource_uri で画像を取得できる

## テスト計画

### 手動テスト（MCP Inspector）

1. jupyter-server を起動
2. jupyter-mcp を起動
3. MCP Inspector で接続
4. session_create でセッション作成
5. execute_code で matplotlib グラフを描画
   ```python
   import matplotlib.pyplot as plt
   plt.figure()
   plt.plot([1, 2, 3], [1, 4, 9])
   plt.title("Test")
   plt.show()
   ```
6. resources/list を実行し、画像がリストに含まれることを確認
7. resources/read で画像 URI を指定し、base64 データが返却されることを確認

### 結合テスト（タスク 7.4 で実施）

- グラフ描画 → 画像取得 → 内容確認の一連フロー

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
