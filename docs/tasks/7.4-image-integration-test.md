# タスク詳細: 7.4 画像リソース結合テスト

## 概要

Phase 7（画像リソース）で実装した機能の結合テストを作成する。

MCPプロトコル経由でグラフ描画→画像リソースURI取得→画像一覧確認→画像データ取得→内容確認の一連のフローが正しく動作することを検証する。

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「F6: 画像出力（MCPリソース）」「AC5: 画像リソース」セクション
- MCP SDK Skill: `.claude/skills/mcp-typescript-server/SKILL.md`

## 背景

Phase 7 では以下の機能を実装した：

| タスク | 内容 | 状態 |
|--------|------|------|
| 7.1 | execute_code の画像出力対応 | 完了 |
| 7.2 | MCP リソース実装（resources/list, resources/read） | 完了 |
| 7.3 | get_image_resource ツール実装 | 完了 |

各機能は個別にテスト済みだが、結合テストとして以下を確認する必要がある：

1. **ワークフローの統合**: グラフ描画→リソース一覧→リソース取得の一連フロー
2. **MCP プロトコル経由のテスト**: Client-Server間の通信をInMemoryTransportで検証
3. **複数セッション対応**: 異なるセッション間での画像分離

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/tests/integration/image-workflow.test.ts` | 画像リソースのワークフロー結合テスト（MCPプロトコル経由） |
| `jupyter-mcp/tests/helpers/mcp-client.ts` | テスト用MCPクライアントヘルパー |

### 実装手順

1. テスト用MCPクライアントヘルパーを作成
   - `@modelcontextprotocol/sdk` の `Client` と `InMemoryTransport` を使用
   - `createServer()` と接続してテスト環境を構築
2. 新しいテストファイル `image-workflow.test.ts` を作成
3. 以下のテストケースを実装:
   - グラフ描画→client.listResources()→client.readResource() の一連フロー
   - 複数セッションでの画像リソース分離確認
   - 画像フォーマット・メタデータ確認
4. 既存テストとの整合性確認
5. 全テスト実行で問題がないことを確認

### テストケース詳細

#### テスト1: グラフ描画→画像取得の完全フロー（MCPプロトコル経由）

```
1. InMemoryTransport でクライアント-サーバー接続を作成
2. client.callTool('session_create', {...}) でセッション作成
3. client.callTool('execute_code', {...}) で matplotlib グラフ描画
4. 戻り値の images[].resource_uri を確認
5. client.listResources() で画像一覧を取得
   - 期待: 生成した画像が一覧に含まれる
6. client.readResource({ uri }) で画像データを取得
   - 期待: base64 PNG データが返る
7. client.callTool('get_image_resource', {...}) でも同じ画像を取得
   - 期待: resources/read と同じデータ
8. client.callTool('session_delete', {...}) でクリーンアップ
```

#### テスト2: 複数セッションでの画像分離

```
1. MCPクライアント接続を作成
2. session_create でセッションA, Bを作成
3. セッションAで matplotlib グラフ1枚描画
4. セッションBで matplotlib グラフ2枚描画
5. client.listResources() で全画像を取得
   - 期待: 計3枚の画像がリストされる
6. 各画像の resource_uri が異なるセッションIDを持つことを確認
7. 各セッションをクリーンアップ
```

#### テスト3: 画像フォーマット・メタデータ確認

```
1. MCPクライアント接続を作成
2. セッション作成 → execute_code でグラフ描画
3. client.readResource() で画像取得
4. 以下を検証:
   - mimeType が "image/png"
   - blob が有効な base64 文字列
   - PNG ヘッダ（iVBORw0KGgo...）で始まることを確認
5. クリーンアップ
```

### 技術的な考慮事項

- **MCP プロトコル経由のテスト**:
  - `@modelcontextprotocol/sdk` の `Client` と `InMemoryTransport.createLinkedPair()` を使用
  - `createServer()` で作成したサーバーに接続
  - `client.listResources()`, `client.readResource()` でリソースAPI経由のテストを実施
- **既存テストとの棲み分け**:
  - `execute-code-images.test.ts`: execute_code の画像出力機能のテスト（handleToolCall直接呼び出し）
  - `get-image-resource.test.ts`: get_image_resource ツールのテスト（handleToolCall直接呼び出し）
  - `image-workflow.test.ts`（新規）: MCPプロトコル経由のワークフロー結合テスト
- **画像ストアの状態**: テスト間で画像ストアの状態がリークしないよう、各テストでセッションを作成・削除する
- **テストヘルパー**: MCPクライアント接続の作成・クローズを簡潔に行うヘルパー関数を作成

## 完了条件

- [x] `tests/helpers/mcp-client.ts` が作成されている
- [x] `image-workflow.test.ts` が作成されている
- [x] MCPプロトコル経由でグラフ描画→listResources→readResource の一連フローがテストされている
- [x] 複数セッションでの画像分離がテストされている
- [x] 画像データの形式（base64 PNG）がテストされている
- [x] `npm test -- image-workflow` でテストが通る
- [x] AC5 の受け入れ条件が満たされている:
  - [x] matplotlibでグラフを描画すると、execute_codeの結果にresource_uriが含まれる
  - [x] resources/list でセッション内の画像一覧が取得できる（MCPプロトコル経由でテスト）
  - [x] resources/read で画像のbase64データが取得できる（MCPプロトコル経由でテスト）
  - [x] get_image_resource ツールで画像データが取得できる

## テスト計画

### 実行方法

```bash
cd jupyter-mcp

# 全テスト実行
npm test

# 結合テストのみ実行
npm test -- image-workflow
```

### 前提条件

- jupyter-server が起動していること（`docker-compose up -d`）
- 環境変数 `JUPYTER_SERVER_URL`, `JUPYTER_TOKEN` が設定されていること

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
