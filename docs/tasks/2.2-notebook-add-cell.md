# タスク詳細: 2.2 notebook_add_cell ツール実装

## 概要

ノートブックにセル（code または markdown）を追加する MCP ツールを実装する。
これにより、AI エージェントが `notebook_create` で作成したノートブックに、分析コードやドキュメントを追加できるようになる。

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「F3.2: セル操作」「notebook_add_cell」セクション
- API仕様: `docs/design/api-contracts.md` の「PATCH /api/contents/{path}/cells」セクション
- MCP実装スキル: `.claude/skills/mcp-typescript-server/SKILL.md`

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/src/tools/notebook-add-cell.ts` | `notebook_add_cell` ツールの実装 |

### 修正するファイル

| ファイル | 変更内容 |
|----------|----------|
| `jupyter-mcp/src/tools/index.ts` | ツール定義の追加、handleToolCall へのルーティング追加 |

### 実装手順

1. **ツール実装ファイルの作成** (`notebook-add-cell.ts`)
   - 引数の型定義
   - バリデーション処理
   - `jupyterClient.operateCell()` の呼び出し
   - レスポンス整形
   - エラーハンドリング

2. **ツール登録** (`index.ts`)
   - `tools` 配列にツール定義を追加
   - `handleToolCall` に分岐を追加

### 技術的な考慮事項

#### 1. 入力パラメータ

要件定義に基づき、以下のパラメータを受け付ける:

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `notebook_path` | string | Yes | ノートブックのパス（例: `analysis.ipynb`） |
| `cell_type` | `"code"` \| `"markdown"` | Yes | セルの種類 |
| `source` | string | Yes | セルの内容 |
| `position` | number | No | 挿入位置（省略時は末尾に追加） |

**注意:** 要件定義には `session_id` があるが、セル操作はノートブックのファイル操作であり、カーネルセッションとは独立している。API仕様 (`PATCH /api/contents/{path}/cells`) もパスベースのため、`notebook_path` をパラメータとする。

#### 2. API呼び出し

既存の `jupyterClient.operateCell()` を使用:

```typescript
await jupyterClient.operateCell(notebookPath, {
  action: 'add',
  cell: {
    cell_type: cellType,
    source: source,
  },
  index: position, // 省略時は undefined → 末尾追加
});
```

#### 3. position パラメータの扱い

- 省略時: 末尾に追加（API側で対応）
- 指定時: 0-indexed で指定位置に挿入

#### 4. エラーケース

| ケース | エラーコード | 対応 |
|--------|-------------|------|
| notebook_path 未指定 | VALIDATION_ERROR | 400 エラー |
| cell_type が不正 | VALIDATION_ERROR | 400 エラー |
| source 未指定 | VALIDATION_ERROR | 400 エラー |
| ノートブックが存在しない | NOTEBOOK_NOT_FOUND | 404 エラー（API から） |
| position が範囲外 | INVALID_CELL_INDEX | 400 エラー（API から） |

#### 5. 既存実装との整合性

`notebook-create.ts` の実装パターンに従い:
- `createErrorResponse` ヘルパー関数を使用
- 成功時は `success: true` を含むJSONレスポンス
- エラー時は `success: false` と `error` オブジェクトを含むレスポンス

## 完了条件

- [ ] `notebook_add_cell` ツールが MCP Inspector のツール一覧に表示される
- [ ] code タイプのセルを追加できる
- [ ] markdown タイプのセルを追加できる
- [ ] position を省略した場合、末尾にセルが追加される
- [ ] position を指定した場合、指定位置にセルが挿入される
- [ ] 存在しないノートブックを指定した場合、適切なエラーが返る
- [ ] 必須パラメータが不足している場合、適切なエラーが返る

## テスト計画

### 手動テスト（MCP Inspector）

1. **正常系: code セル追加**
   ```json
   {
     "notebook_path": "test.ipynb",
     "cell_type": "code",
     "source": "print('Hello, World!')"
   }
   ```
   - 期待: 成功レスポンス、ノートブック末尾にセルが追加される

2. **正常系: markdown セル追加**
   ```json
   {
     "notebook_path": "test.ipynb",
     "cell_type": "markdown",
     "source": "# タイトル\n\nこれはテストです。"
   }
   ```
   - 期待: 成功レスポンス

3. **正常系: position 指定**
   ```json
   {
     "notebook_path": "test.ipynb",
     "cell_type": "code",
     "source": "x = 1",
     "position": 0
   }
   ```
   - 期待: 先頭にセルが挿入される

4. **異常系: ノートブック未存在**
   ```json
   {
     "notebook_path": "nonexistent.ipynb",
     "cell_type": "code",
     "source": "x = 1"
   }
   ```
   - 期待: NOTEBOOK_NOT_FOUND エラー

5. **異常系: 必須パラメータ不足**
   ```json
   {
     "notebook_path": "test.ipynb"
   }
   ```
   - 期待: VALIDATION_ERROR

### E2Eテスト（タスク 2.3 で実施）

- `notebook_create` → `notebook_add_cell` の連続フローテスト

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [ ] テスト完了（E2Eテストはタスク2.3で実施）
