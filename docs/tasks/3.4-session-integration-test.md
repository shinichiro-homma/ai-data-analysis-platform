# タスク詳細: 3.4 セッション管理の結合テスト

## 概要

セッション管理機能（session_create、session_list、session_delete）の結合テストを実装する。

Phase 3 で実装した 3 つの MCP ツールが一連のフローとして正しく動作することを検証し、実際の jupyter-server との連携を確認する。

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「F1: セッション管理」「AC1: セッション管理」セクション
- API仕様: `docs/design/api-contracts.md` の「カーネル管理」セクション（POST/GET/DELETE /api/kernels）
- 既存テスト: `jupyter-mcp/tests/integration/notebook.test.ts`（ノートブック操作の結合テスト、参考）

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/tests/integration/session.test.ts` | セッション管理の結合テスト |

### 実装手順

1. **テストファイルの作成**
   - `tests/integration/session.test.ts` を新規作成
   - 既存の `notebook.test.ts` の構造を参考に、`vitest` を使用

2. **ヘルパー関数の追加**
   - `tests/setup.ts` にセッション（カーネル）のクリーンアップ関数を追加
   - テスト後に作成したカーネルを確実に削除

3. **テストケースの実装**
   - 各ツールの単体動作確認
   - 一連フロー（作成→一覧→削除）の動作確認
   - エラーケースの確認

### テストケース詳細

#### 基本テストケース

| # | テスト名 | 検証内容 |
|---|----------|----------|
| 1 | session_create で新しいセッションが作成される | カーネルが起動し、session_id と status が返る |
| 2 | session_list で作成したセッションが表示される | 作成したセッションが一覧に含まれる |
| 3 | session_delete でセッションが削除される | 削除後に一覧から消える |
| 4 | 一連フロー（作成→一覧確認→削除）が動作する | E2Eフローテスト |

#### エラーケース

| # | テスト名 | 検証内容 |
|---|----------|----------|
| 5 | 存在しない session_id で削除するとエラー | KERNEL_NOT_FOUND エラーが返る |
| 6 | session_delete に session_id を指定しないとエラー | VALIDATION_ERROR が返る |

### テストの構造

```typescript
describe('セッション管理の結合テスト', () => {
  // テストで作成したセッションIDを保持（クリーンアップ用）
  const createdSessionIds: string[] = [];

  beforeAll(async () => {
    // Jupyter サーバーの接続確認
    await checkJupyterConnection();
  });

  afterEach(async () => {
    // テスト後のクリーンアップ
    for (const sessionId of createdSessionIds) {
      await cleanupSession(sessionId);
    }
    createdSessionIds.length = 0;
  });

  test('session_create で新しいセッションが作成される', async () => { ... });
  test('session_list で作成したセッションが表示される', async () => { ... });
  test('session_delete でセッションが削除される', async () => { ... });
  test('セッション作成→一覧確認→削除の一連フローが動作する', async () => { ... });

  describe('エラーケース', () => {
    test('存在しない session_id で削除するとエラーが返る', async () => { ... });
    test('session_delete に session_id を指定しないとエラーが返る', async () => { ... });
  });
});
```

### 技術的な考慮事項

#### クリーンアップの重要性
- テストで作成したカーネルは必ず削除する
- テスト失敗時でも `afterEach` でクリーンアップが実行される
- カーネルが残ると jupyter-server のリソースを消費し続ける

#### 非同期処理の考慮
- カーネル起動には時間がかかる場合がある
- status が "starting" から "idle" に変わるまで待機が必要な場合がある
- テストタイムアウトは余裕を持って設定

#### テストの独立性
- 各テストは独立して実行可能であること
- テスト間でセッションを共有しない（テスト順序依存を避ける）

## 完了条件

- [x] `tests/integration/session.test.ts` が作成されている
- [x] `tests/setup.ts` にクリーンアップ関数が追加されている
- [x] 4つの基本テストケースがすべてパスする
- [x] 2つのエラーケースがすべてパスする
- [x] `npm run test:integration` で結合テストが実行できる
- [x] テスト後にカーネルが残っていない（クリーンアップが正常に動作）

## テスト計画

### 前提条件
- docker-compose up -d で jupyter-server が起動していること
- 環境変数 JUPYTER_SERVER_URL, JUPYTER_TOKEN が設定されていること

### 実行コマンド
```bash
cd jupyter-mcp
npm run test:integration
```

### 検証方法
1. テストがすべてパスすることを確認
2. テスト実行後に `curl http://localhost:8888/api/kernels` でカーネルが残っていないことを確認

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
