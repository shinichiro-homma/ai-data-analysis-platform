# タスク詳細: 5.2 get_dataframe_info ツール実装

## 概要

セッション内の DataFrame 変数の詳細情報を取得する MCP ツールを実装する。AI エージェントがデータの構造と概要を把握するために使用する。

**なぜこのタスクが必要か:**
- `get_variables` では変数名と型のみしかわからない
- DataFrame の詳細（カラム情報、先頭行、統計情報）を取得することで、AI がデータ構造を理解し、適切な分析コードを生成できる

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「F4.2: 変数詳細取得」セクション
- API仕様: `docs/design/api-contracts.md` の「GET /api/kernels/{kernel_id}/variables/{name}」セクション
- Skill: `.claude/skills/mcp-typescript-server/SKILL.md`

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/src/tools/get-dataframe-info.ts` | ツール実装（入力検証、API呼び出し、レスポンス整形） |

### 修正するファイル

| ファイル | 変更内容 |
|----------|----------|
| `jupyter-mcp/src/tools/index.ts` | ツール定義の追加、handleToolCall へのルーティング追加 |

### 実装手順

1. **ツール実装ファイル作成** (`get-dataframe-info.ts`)
   - 入力パラメータの検証（session_id, variable_name）
   - session_id → kernel_id への解決（`resolveKernelId` 使用）
   - `jupyterClient.getVariable()` を呼び出してデータ取得
   - 変数が DataFrame でない場合のエラーハンドリング
   - MCP レスポンス形式への整形

2. **ツール定義追加** (`index.ts`)
   - `get_dataframe_info` のツール定義を追加
   - `executeGetDataframeInfo` 関数をインポート
   - `handleToolCall` に case を追加

3. **ビルド確認**
   - `npm run typecheck` で型エラーがないことを確認
   - `npm run build` でビルドが成功することを確認

### 技術的な考慮事項

1. **DataFrame 判定**
   - 取得した変数の型が `DataFrame` かどうかを確認
   - `DataFrame` でない場合は適切なエラーを返す

2. **オプションパラメータ**
   - `include_head`: 先頭行を含めるか（デフォルト: true）
   - `head_rows`: 先頭何行を取得するか（デフォルト: 5）
   - jupyter-server 側で対応していない場合は、MCP 側でフィルタリングする

3. **レスポンスサイズ**
   - 大きな DataFrame の場合、レスポンスが大きくなりすぎないよう注意
   - `head` は指定行数のみ、`describe` は数値カラムのみに限定

4. **既存実装パターンの踏襲**
   - `get-variables.ts` と同様のパターンで実装
   - `validateStringParameter` による入力検証
   - `resolveKernelId` によるセッション解決
   - `createSuccessResponse` / `createErrorResponse` によるレスポンス生成

## 完了条件

- [x] `get_dataframe_info` ツールが `registerTools()` で返される
- [x] session_id と variable_name を指定して DataFrame 情報が取得できる
- [x] 存在しない変数名を指定した場合、適切なエラーが返る
- [x] DataFrame でない変数を指定した場合、適切なエラーが返る
- [x] `include_head`/`head_rows` オプションが正しく機能する
- [x] `npm run typecheck` が成功する
- [x] `npm run build` が成功する

## テスト計画

### 手動テスト（MCP Inspector）

1. セッション作成
2. DataFrame を定義するコードを実行
   ```python
   import pandas as pd
   df = pd.DataFrame({
       'id': [1, 2, 3, 4, 5],
       'name': ['A', 'B', 'C', 'D', 'E'],
       'value': [100.5, 200.3, 150.0, 180.2, 120.8]
   })
   ```
3. `get_dataframe_info` を呼び出して結果確認
4. 存在しない変数名でエラー確認
5. DataFrame でない変数（`x = 42`）でエラー確認

### 期待されるレスポンス形式

```json
{
  "success": true,
  "shape": [5, 3],
  "columns": ["id", "name", "value"],
  "dtypes": {
    "id": "int64",
    "name": "object",
    "value": "float64"
  },
  "head": [
    {"id": 1, "name": "A", "value": 100.5},
    {"id": 2, "name": "B", "value": 200.3},
    {"id": 3, "name": "C", "value": 150.0},
    {"id": 4, "name": "D", "value": 180.2},
    {"id": 5, "name": "E", "value": 120.8}
  ],
  "describe": {
    "id": {"count": 5, "mean": 3.0, "std": 1.58, "min": 1, "max": 5},
    "value": {"count": 5, "mean": 150.36, "std": 38.47, "min": 100.5, "max": 200.3}
  }
}
```

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [ ] テスト完了（タスク5.3で実施）
