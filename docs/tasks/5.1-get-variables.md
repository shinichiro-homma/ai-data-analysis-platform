# タスク詳細: 5.1 get_variables ツール実装

## 概要

jupyter-mcp に `get_variables` ツールを追加する。このツールは、指定したセッション内で定義済みの変数一覧を取得し、変数名、型、サイズ（概算）を返す。

分析の途中経過を確認したり、どのような変数が定義されているかをAIが把握するために必要な機能。

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「F4: 変数・データ操作」セクション
  - F4.1: 変数一覧
- API仕様: `docs/design/api-contracts.md` の「変数管理」セクション
  - GET /api/kernels/{kernel_id}/variables
- MCPツール定義: `docs/requirements/jupyter-mcp.md` の「get_variables」セクション

## 既存実装の確認

以下の実装は既に完了している（再利用可能）:

### jupyter-server 側

- `handlers.py`: `KernelVariablesHandler` - GET /api/kernels/{kernel_id}/variables
- `kernel_executor.py`: `get_variables()` - カーネル内の変数一覧を取得するロジック

### jupyter-mcp 側

- `jupyter-client/client.ts`: `getVariables(kernelId)` メソッド - API呼び出しクライアント
- `jupyter-client/types.ts`: `Variable` 型定義

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/src/tools/get-variables.ts` | get_variables ツールの実装 |
| `jupyter-mcp/tests/integration/get-variables.test.ts` | 結合テスト |

### 修正するファイル

| ファイル | 修正内容 |
|----------|----------|
| `jupyter-mcp/src/tools/index.ts` | ツール定義の追加、handleToolCall へのルーティング追加 |

### 実装手順

1. **get-variables.ts の作成**
   - `executeGetVariables` 関数を実装
   - `session_id` パラメータを受け取る
   - `session_id` を `kernel_id` に解決（execute-code.ts と同じパターン）
   - `jupyterClient.getVariables(kernelId)` を呼び出し
   - 成功/エラーレスポンスを返却

2. **index.ts の修正**
   - `get_variables` ツールの定義を追加
   - `handleToolCall` に分岐を追加
   - `executeGetVariables` をインポート

3. **結合テストの作成**
   - セッション作成 → 変数定義（`x = 42`, `df = pd.DataFrame(...)`）→ get_variables で変数一覧取得
   - 変数の型・サイズが正しく取得できることを確認

### 技術的な考慮事項

- **session_id の解決**: execute-code.ts で実装済みの `resolveKernelId` と同じロジックを使用する。共通関数として切り出すか、または同じパターンで実装する。
- **エラーハンドリング**: 存在しないセッションの場合、KERNEL_NOT_FOUND エラーを返す
- **パフォーマンス**: 変数一覧取得はカーネル内でPythonコードを実行するため、多少の遅延がある（許容範囲）

## ツール定義（API仕様準拠）

```typescript
{
  name: "get_variables",
  description: "セッション内で定義されている変数の一覧を取得します。",
  inputSchema: {
    type: "object",
    properties: {
      session_id: {
        type: "string",
        description: "セッションID"
      }
    },
    required: ["session_id"]
  }
}
```

## レスポンス形式

```json
{
  "success": true,
  "variables": [
    {"name": "df", "type": "DataFrame", "size": "1000 rows × 5 cols"},
    {"name": "x", "type": "int", "value": 42},
    {"name": "model", "type": "LinearRegression", "size": "..."}
  ]
}
```

## 完了条件

- [x] `get-variables.ts` が作成され、`executeGetVariables` が実装されている
- [x] `index.ts` に `get_variables` ツールが登録されている
- [x] MCPツールで定義済み変数一覧が取得できる
- [x] 変数の型（int, float, str, DataFrame など）が正しく返る
- [x] DataFrameの場合、サイズ（rows × cols）が返る
- [x] 単純な値（int, float, str, bool）の場合、value が返る
- [x] 存在しないセッションの場合、エラーが返る
- [x] 結合テストが通る

## テスト計画

### 結合テスト

```typescript
describe('get_variables ツールの結合テスト', () => {
  test('変数定義後に get_variables で一覧が取得できる', async () => {
    // 1. セッション作成
    // 2. x = 42 を実行
    // 3. df = pd.DataFrame(...) を実行
    // 4. get_variables を呼び出し
    // 5. x と df が変数一覧に含まれることを確認
    // 6. x の type が 'int', value が 42 であることを確認
    // 7. df の type が 'DataFrame', size に 'rows' が含まれることを確認
  });

  test('変数が未定義の場合、空配列が返る', async () => {
    // 1. セッション作成
    // 2. get_variables を呼び出し
    // 3. variables が空配列であることを確認
  });

  test('存在しないセッションの場合、エラーが返る', async () => {
    // 1. 存在しない session_id で get_variables を呼び出し
    // 2. エラーが返ることを確認
  });
});
```

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
