# タスク詳細: 1.2.2 jupyter-client 実装

## 概要

jupyter-mcp から jupyter-server の REST API を呼び出すためのクライアント基盤を実装する。
このクライアントは、後続のタスク（セッション管理、コード実行、ノートブック操作等）で使用される共通モジュールとなる。

**なぜこのタスクが必要か:**
- MCPツールが jupyter-server と通信するための基盤が必要
- 各ツール実装時に毎回HTTP通信を書くのは非効率
- エラーハンドリング、認証、タイムアウト等を一元管理するため

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「技術仕様」セクション
- API仕様: `docs/design/api-contracts.md` の「jupyter-server API」セクション
- Skill: `.claude/skills/mcp-typescript-server/SKILL.md`

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/src/jupyter-client/types.ts` | 型定義（API リクエスト/レスポンス） |
| `jupyter-mcp/src/jupyter-client/errors.ts` | エラークラス定義 |
| `jupyter-mcp/src/jupyter-client/client.ts` | HTTP クライアント実装 |
| `jupyter-mcp/src/jupyter-client/index.ts` | エクスポート |

### 実装手順

#### 1. 型定義（types.ts）

API仕様に基づいて以下の型を定義:

```typescript
// カーネル関連
interface Kernel {
  id: string;
  name: string;
  status: 'starting' | 'idle' | 'busy' | 'dead';
  started_at: string;
  execution_count?: number;
}

// コード実行関連
interface ExecuteRequest {
  code: string;
  timeout?: number;
}

interface ExecuteResult {
  success: boolean;
  execution_count: number;
  outputs: Output[];
  result: unknown | null;
  images: ImageOutput[];
  execution_time_ms: number;
  error?: ExecutionError;
}

// ファイル/ノートブック関連
interface ContentItem {
  name: string;
  type: 'notebook' | 'file' | 'directory';
  size?: number;
  modified_at: string;
}

// 変数関連
interface Variable {
  name: string;
  type: string;
  value?: unknown;
  size?: string;
  memory_bytes?: number;
}
```

#### 2. エラークラス（errors.ts）

```typescript
class JupyterClientError extends Error {
  constructor(message: string, public code: string, public statusCode: number);
}

class KernelNotFoundError extends JupyterClientError { ... }
class ExecutionTimeoutError extends JupyterClientError { ... }
class ConnectionError extends JupyterClientError { ... }
```

#### 3. クライアント実装（client.ts）

環境変数から設定を読み込み、axios を使用して API を呼び出す:

```typescript
class JupyterClient {
  private baseUrl: string;
  private token: string;
  private axios: AxiosInstance;

  constructor(config?: { baseUrl?: string; token?: string });

  // カーネル管理
  async createKernel(name?: string): Promise<Kernel>;
  async listKernels(): Promise<Kernel[]>;
  async getKernel(kernelId: string): Promise<Kernel>;
  async deleteKernel(kernelId: string): Promise<void>;
  async interruptKernel(kernelId: string): Promise<void>;
  async restartKernel(kernelId: string): Promise<void>;

  // コード実行
  async executeCode(kernelId: string, request: ExecuteRequest): Promise<ExecuteResult>;

  // 変数管理
  async getVariables(kernelId: string): Promise<Variable[]>;
  async getVariable(kernelId: string, name: string): Promise<Variable>;

  // ファイル/ノートブック管理
  async listContents(path?: string): Promise<ContentItem[]>;
  async getContents(path: string): Promise<NotebookContent>;
  async createNotebook(path: string): Promise<ContentItem>;
  async updateNotebook(path: string, content: NotebookContent): Promise<void>;
  async addCell(path: string, cell: Cell, index?: number): Promise<void>;

  // ヘルスチェック
  async healthCheck(): Promise<HealthStatus>;
}

// シングルトンインスタンス
export const jupyterClient = new JupyterClient();
```

#### 4. エクスポート（index.ts）

```typescript
export { JupyterClient, jupyterClient } from './client.js';
export * from './types.js';
export * from './errors.js';
```

### 技術的な考慮事項

1. **環境変数の取り扱い**
   - `JUPYTER_SERVER_URL`: デフォルト `http://localhost:8888`
   - `JUPYTER_TOKEN`: 必須（未設定時はエラー）
   - 起動時に接続確認を行い、接続できない場合は警告を出力

2. **認証方式**
   - Jupyter Server はトークン認証を使用
   - `Authorization: Bearer {token}` ヘッダーで認証

3. **タイムアウト設定**
   - デフォルトタイムアウト: 30秒
   - コード実行時は個別にタイムアウト指定可能
   - axios の `timeout` オプションを使用

4. **エラーハンドリング戦略**
   - HTTP ステータスコードに応じたエラークラスを使用
   - 404 → KernelNotFoundError / NotebookNotFoundError
   - 408/timeout → ExecutionTimeoutError
   - 接続エラー → ConnectionError
   - エラーメッセージは日本語対応（MCPツールからユーザーに表示されるため）

5. **レスポンス形式の変換**
   - API仕様の `{ data: ... }` 形式から内部で使いやすい形式に変換
   - snake_case → camelCase 変換は行わない（APIとの整合性優先）

## 完了条件

- [x] `types.ts`: API仕様に基づいた型定義が完了
- [x] `errors.ts`: エラークラスが定義され、適切なエラーコードを持つ
- [x] `client.ts`: 全APIメソッドが実装されている
- [x] `client.ts`: 環境変数から設定を読み込む
- [x] `client.ts`: 認証ヘッダーが正しく設定される
- [x] `client.ts`: エラーハンドリングが実装されている
- [x] `index.ts`: 必要なエクスポートが揃っている
- [x] TypeScript ビルドが通る（`npm run typecheck`）
- [x] jupyter-server API と疎通確認ができる

## テスト計画

### 手動テスト（E2E）

1. jupyter-server を起動
   ```bash
   cd jupyter-server && docker-compose up -d
   ```

2. 疎通確認スクリプトの作成・実行
   ```typescript
   // test-client.ts
   import { jupyterClient } from './src/jupyter-client/index.js';

   async function main() {
     // ヘルスチェック
     const health = await jupyterClient.healthCheck();
     console.log('Health:', health);

     // カーネル作成
     const kernel = await jupyterClient.createKernel();
     console.log('Created kernel:', kernel);

     // コード実行
     const result = await jupyterClient.executeCode(kernel.id, {
       code: 'print("Hello from jupyter-client!")'
     });
     console.log('Execution result:', result);

     // カーネル削除
     await jupyterClient.deleteKernel(kernel.id);
     console.log('Kernel deleted');
   }

   main().catch(console.error);
   ```

3. 期待される出力
   - ヘルスチェックが成功
   - カーネルが作成される
   - コード実行結果に `stdout: "Hello from jupyter-client!\n"` が含まれる
   - カーネルが削除される

### エラーケース確認

- [ ] トークンが不正な場合、認証エラーが返る
- [ ] 存在しないカーネルIDを指定した場合、KernelNotFoundError が発生
- [ ] jupyter-server が停止している場合、ConnectionError が発生

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
