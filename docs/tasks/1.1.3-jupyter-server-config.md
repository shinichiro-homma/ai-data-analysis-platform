# タスク詳細: 1.1.3 jupyter_server_config.py 作成

## 概要

Jupyter Server の設定ファイルを作成し、トークン認証とCORS設定を行う。これにより、jupyter-mcp からの REST API アクセスを安全かつ正常に受け付けられるようにする。

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-server.md`
  - 「NF2: セキュリティ」セクション（信頼されたネットワーク内での動作）
  - 「環境変数」セクション（JUPYTER_TOKEN の定義）
- 既存ファイル: `jupyter-server/Dockerfile`（設定ファイルのコピー箇所がコメントアウト）
- 参考: [Jupyter Server Security Documentation](https://jupyter-server.readthedocs.io/en/latest/operators/security.html)

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-server/jupyter_config/jupyter_server_config.py` | Jupyter Server のメイン設定ファイル |

### 実装手順

1. **ディレクトリ作成**
   - `jupyter-server/jupyter_config/` ディレクトリを作成

2. **設定ファイル作成**
   - `jupyter_server_config.py` を作成し、以下の設定を含める：
     - トークン認証（環境変数から読み込み）
     - CORS 設定（jupyter-mcp からのアクセス許可）
     - IP バインディング（コンテナ内からのアクセス許可）
     - その他基本設定

3. **Dockerfile の更新**
   - コメントアウトされている設定ファイルのコピー行を有効化

### 設定内容の詳細

```python
# jupyter_server_config.py

import os
import sys

c = get_config()

# =============================================================================
# トークン認証
# =============================================================================
# 環境変数 JUPYTER_TOKEN から認証トークンを取得
jupyter_token = os.environ.get('JUPYTER_TOKEN', '')

# トークンが未設定の場合はエラーで起動を中止
if not jupyter_token:
    print("ERROR: JUPYTER_TOKEN environment variable is required but not set.", file=sys.stderr)
    print("Please set JUPYTER_TOKEN in your .env file or environment.", file=sys.stderr)
    sys.exit(1)

c.ServerApp.token = jupyter_token

# =============================================================================
# CORS 設定
# =============================================================================
# jupyter-mcp (ポート 3001) からのアクセスを許可
# 開発環境では全オリジンを許可（本番では制限推奨）
c.ServerApp.allow_origin = '*'

# 認証情報（Cookie等）を含むリクエストを許可
c.ServerApp.allow_credentials = True

# =============================================================================
# ネットワーク設定
# =============================================================================
# すべてのネットワークインターフェースでリッスン（コンテナ環境用）
c.ServerApp.ip = '0.0.0.0'

# ポート（docker-compose.yml と一致させる）
c.ServerApp.port = 8888

# ブラウザの自動起動を無効化（コンテナ環境では不要）
c.ServerApp.open_browser = False

# =============================================================================
# ワークスペース設定
# =============================================================================
# デフォルトの作業ディレクトリ
c.ServerApp.root_dir = '/home/jovyan/work'
```

### 技術的な考慮事項

1. **トークン認証**
   - `JUPYTER_TOKEN` 環境変数が未設定または空の場合、起動時にエラーで中止
   - 設定ファイル内でバリデーションを行い、明確なエラーメッセージを出力
   - `.env` ファイルでトークン値を管理

2. **CORS 設定**
   - 開発環境では `allow_origin = '*'` で全オリジンを許可
   - `allow_credentials = True` により、トークン付きリクエストを受け付け
   - 本番環境では `allow_origin_pat` を使って特定オリジンのみ許可することを推奨

3. **IP バインディング**
   - `ip = '0.0.0.0'` によりコンテナ外からのアクセスを許可
   - Docker ネットワーク内での通信に必要

4. **代替案の検討**
   - `allow_origin_pat` を使用する案：正規表現でオリジンを制限可能だが、開発段階では柔軟性を優先
   - 本番環境向けの設定は Phase 10（全体統合）で検討

## 完了条件

- [x] `jupyter-server/jupyter_config/jupyter_server_config.py` が作成されている
- [x] トークン認証が環境変数から設定される
- [x] トークン未設定時にエラーで起動が中止される
- [x] CORS が正しく設定されている
- [x] Dockerfile の COPY 行が有効化されている
- [x] `docker-compose up` で Jupyter Server が起動する
- [x] トークン付きで REST API にアクセスできる

## テスト計画

### 手動テスト

1. **起動確認**
   ```bash
   cd jupyter-server
   docker-compose up -d
   docker-compose logs jupyter-server
   ```
   - エラーなく起動することを確認
   - 設定ファイルが読み込まれていることをログで確認

2. **トークン未設定時のバリデーションテスト**
   ```bash
   # .env から JUPYTER_TOKEN を一時的に削除またはコメントアウト
   # または空の値で起動
   JUPYTER_TOKEN= docker-compose up
   ```
   - エラーメッセージ「JUPYTER_TOKEN environment variable is required」が表示されること
   - コンテナが起動せずに終了すること

3. **認証テスト**
   ```bash
   # トークンなし（401 エラーを期待）
   curl -I http://localhost:8888/api/kernels

   # トークンあり（200 OK を期待）
   curl -I -H "Authorization: token ${JUPYTER_TOKEN}" http://localhost:8888/api/kernels
   ```

4. **CORS テスト**
   ```bash
   # OPTIONS リクエストで CORS ヘッダを確認
   curl -I -X OPTIONS \
     -H "Origin: http://localhost:3001" \
     -H "Access-Control-Request-Method: POST" \
     http://localhost:8888/api/kernels
   ```
   - `Access-Control-Allow-Origin` ヘッダが返却されることを確認

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
