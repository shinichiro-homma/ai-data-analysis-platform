# タスク詳細: 3.3 session_delete ツール実装

## 概要

分析セッション（カーネル）を終了するための MCP ツール `session_delete` を実装する。
セッション終了時に関連するリソースをクリーンアップし、AIエージェントが分析完了後に適切にリソース解放できるようにする。

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「F1.2: セッション終了」セクション
- API仕様: `docs/design/api-contracts.md` の「DELETE /api/kernels/{kernel_id}」セクション
- Skill: `.claude/skills/mcp-typescript-server/SKILL.md`

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/src/tools/session-delete.ts` | session_delete ツール実装 |

### 変更するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/src/tools/index.ts` | ツール定義追加、ルーティング追加 |

### 実装手順

1. **ツール実装ファイル作成** (`src/tools/session-delete.ts`)
   - 既存の `session-create.ts`, `session-list.ts` の実装パターンに従う
   - `SessionDeleteArgs` インターフェースを定義（`session_id` を必須パラメータとして）
   - 入力検証:
     - `session_id` が文字列であること
     - `session_id` が空でないこと
     - `session_id` の長さチェック（DoS対策）
     - NULLバイト攻撃対策
   - `jupyterClient.deleteKernel()` を呼び出し
   - 成功時: 削除されたセッション情報を返却
   - エラー時: 適切なエラーレスポンスを返却

2. **ツール定義追加** (`src/tools/index.ts`)
   - `session_delete` ツール定義を `tools` 配列に追加
   - `executeSessionDelete` をインポート
   - `handleToolCall` の switch 文にルーティング追加

### 技術的な考慮事項

- **既存実装との整合性**: `session-create.ts`, `session-list.ts` と同じパターンで実装
- **エラーハンドリング**:
  - 存在しないセッションIDを指定した場合は `KERNEL_NOT_FOUND` エラー
  - クライアントの `deleteKernel` メソッドがすでにエラーハンドリングを実装済み
- **レスポンス形式**: 要件定義には明記されていないが、session_id と status("deleted") を返却

### ツール定義（参考: 要件定義より）

```typescript
{
  name: "session_delete",
  description: "分析セッションを終了し、リソースを解放します。",
  inputSchema: {
    type: "object",
    properties: {
      session_id: {
        type: "string",
        description: "終了するセッションID"
      }
    },
    required: ["session_id"]
  }
}
```

### API呼び出し

```
DELETE /api/kernels/{kernel_id}
```

レスポンス:
```json
{
  "data": {
    "id": "kernel-abc123",
    "status": "deleted"
  }
}
```

## 完了条件

- [x] `session_delete` ツールが `session_id` パラメータを受け取る
- [x] 入力検証が適切に行われる
  - [x] `session_id` が必須
  - [x] 型チェック、長さチェック、NULLバイトチェック
- [x] 正常系: セッションが終了し、削除されたセッション情報が返る
- [x] 異常系: 存在しないセッションIDで適切なエラーが返る
- [x] `src/tools/index.ts` にツール定義とルーティングが追加される
- [x] 型エラーなくビルドが通る (`npm run typecheck`)

## テスト計画

### 手動テスト（MCP Inspector）

1. **正常系テスト**
   - `session_create` でセッションを作成
   - `session_list` でセッションが存在することを確認
   - `session_delete` でセッションを削除
   - `session_list` でセッションが削除されていることを確認

2. **エラーケーステスト**
   - `session_id` を省略 → バリデーションエラー
   - 存在しないセッションIDを指定 → `KERNEL_NOT_FOUND` エラー
   - 空文字列を指定 → バリデーションエラー

### テストコマンド

```bash
# ビルド確認
cd jupyter-mcp && npm run typecheck && npm run build

# MCP Inspector での動作確認
npx @modelcontextprotocol/inspector node dist/index.js
```

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
