# タスク詳細: 4.1 execute_code ツール実装

## 概要

jupyter-mcp に `execute_code` MCP ツールを実装し、Python コードを実行して結果を取得できるようにする。このツールは AI がデータ分析を行う際の中核機能であり、セッション作成後にコードを実行して stdout、エラー、実行時間などを取得できる。

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「F2: コード実行」「execute_code」セクション
- API仕様: `docs/design/api-contracts.md` の「POST /api/kernels/{kernel_id}/execute」セクション
- MCP Skill: `.claude/skills/mcp-typescript-server/SKILL.md`

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/src/tools/execute-code.ts` | execute_code ツールの実装 |

### 修正するファイル

| ファイル | 変更内容 |
|----------|----------|
| `jupyter-mcp/src/tools/index.ts` | execute_code ツールの定義追加、ルーティング追加 |

### 実装手順

1. **execute-code.ts の作成**
   - session_id または kernel_id でセッション/カーネルを特定
   - JupyterClient.executeCode() を呼び出し
   - 結果を MCP レスポンス形式に変換

2. **ツール定義の追加（index.ts）**
   - 要件定義に従った inputSchema を追加:
     - `session_id` (string, required): セッションID
     - `code` (string, required): 実行する Python コード
     - `timeout` (number, optional): タイムアウト秒数（デフォルト30秒）

3. **レスポンス形式**
   - 成功時:
     ```json
     {
       "success": true,
       "stdout": "出力文字列",
       "stderr": "",
       "result": null,
       "images": [],
       "execution_time_ms": 15
     }
     ```
   - エラー時:
     ```json
     {
       "success": false,
       "error_type": "ZeroDivisionError",
       "error_message": "division by zero",
       "traceback": "..."
     }
     ```

### 技術的な考慮事項

- **session_id から kernel_id への変換**
  - execute_code は session_id を受け取るが、JupyterClient.executeCode() は kernel_id を必要とする
  - session_create が notebook_path なしで呼ばれた場合、kernel_id が直接返される
  - session_create が notebook_path 付きで呼ばれた場合、session_id が返される
  - 実装方針: session_id をそのまま kernel_id として扱う（session_id として返されるのは実際には kernel.id または session.id だが、カーネル ID として使える）
  - notebook_path付きの場合: session.kernel.id を使う必要がある

- **session_id の解決ロジック**
  1. session_id で session を検索（listSessions から）
  2. 見つかった場合: session.kernel.id を使用
  3. 見つからない場合: session_id をそのまま kernel_id として使用（notebook_path なしで作成された場合）

- **タイムアウト処理**
  - タイムアウトは jupyter-server の execute API に渡す
  - デフォルト30秒、最大300秒（5分）に制限

- **入力検証**
  - session_id: 必須、文字列、空でないこと
  - code: 必須、文字列（空コードは許可 - 何もしないだけ）
  - timeout: オプション、数値、0 < timeout <= 300

- **画像出力への対応**
  - Phase 4.1 では基本実装のため、images 配列はそのまま返す
  - Phase 7 で画像リソース対応を行う予定

## 完了条件

- [ ] `execute_code` ツールが MCP Inspector で表示される
- [ ] `print("hello")` を実行し、stdout に "hello\n" が返る
- [ ] 変数代入（例: `x = 1 + 2`）を実行し、成功が返る
- [ ] session_id が存在しない場合、適切なエラーが返る
- [ ] code パラメータが空の場合でもエラーにならない（何も実行しない）

## テスト計画

### 手動テスト（MCP Inspector）

1. **基本的なコード実行**
   ```
   session_create → execute_code(code="print('hello')") → stdout に "hello\n"
   ```

2. **変数代入**
   ```
   execute_code(code="x = 42") → 成功
   execute_code(code="print(x)") → stdout に "42\n"
   ```

3. **エラーハンドリング（Phase 4.2 で詳細テスト）**
   - 本タスクでは execute_code の基本実装のみ
   - エラーレスポンスの詳細は次タスクで対応

4. **存在しないセッション**
   ```
   execute_code(session_id="invalid", code="print(1)") → エラー
   ```

### E2E テスト

- docs/PLAN.md の E2E テスト欄に記載:
  > MCPツールで `print("hello")` を実行し結果が返る

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
