# タスク詳細: 7.1 execute_code の画像出力対応

## 概要

execute_code ツールで matplotlib 等のグラフ描画コードを実行した際に、生成された画像を images 配列で返却する機能を実装する。

現在、jupyter-server 側では既に画像出力の処理が実装されている（`kernel_executor.py` の `display_data` メッセージ処理）。jupyter-mcp 側でも ExecuteResult に images フィールドが定義されているが、execute_code ツールのレスポンスでは画像データをそのまま返しているだけで、MCPリソースURI への変換が行われていない。

このタスクでは以下を実現する：
1. execute_code の結果に含まれる画像データを適切にフォーマットして返す
2. 画像に resource_uri を付与し、後続の MCP リソース機能（タスク 7.2, 7.3）と連携可能にする

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「F6: 画像出力（MCPリソース）」セクション
  - F6.1: 実行結果の画像取得
- API仕様: `docs/design/api-contracts.md` の「POST /api/kernels/{kernel_id}/execute」セクション
  - レスポンス（画像出力あり）の形式

### 要件定義の抜粋

**execute_code の戻り値（画像あり）:**
```json
{
  "success": true,
  "stdout": "",
  "stderr": "",
  "result": null,
  "images": [
    {
      "resource_uri": "jupyter://session-abc123/images/output-001.png",
      "mime_type": "image/png",
      "description": "matplotlib output [1]"
    }
  ],
  "execution_time_ms": 1200
}
```

## 実装計画

### 作成・修正するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/src/image-store/index.ts` | 画像ストアの実装（新規） |
| `jupyter-mcp/src/image-store/types.ts` | 画像ストアの型定義（新規） |
| `jupyter-mcp/src/tools/execute-code.ts` | 画像出力対応（修正） |
| `jupyter-mcp/tests/integration/execute-code-images.test.ts` | 画像出力テスト（新規） |

### 実装手順

#### 1. 画像ストアの型定義

`src/image-store/types.ts` を作成：

```typescript
export interface StoredImage {
  id: string;
  sessionId: string;
  mimeType: string;
  data: string;  // base64
  width?: number;
  height?: number;
  createdAt: Date;
  description: string;
}

export interface ImageReference {
  resource_uri: string;
  mime_type: string;
  description: string;
}
```

#### 2. 画像ストアの実装

`src/image-store/index.ts` を作成：

- インメモリで画像を保存
- session_id + image_id からリソースURIを生成
- リソースURIから画像データを取得するメソッド
- セッション終了時に関連画像を削除するメソッド

```typescript
class ImageStore {
  private images: Map<string, StoredImage> = new Map();

  store(sessionId: string, imageData: ImageOutput): ImageReference
  get(resourceUri: string): StoredImage | undefined
  listBySession(sessionId: string): StoredImage[]
  deleteBySession(sessionId: string): void
}
```

#### 3. execute_code の修正

`src/tools/execute-code.ts` を修正：

- 実行結果の images 配列を処理
- 各画像を ImageStore に保存
- resource_uri を含む ImageReference 形式でレスポンスを返す

```typescript
// 画像を処理
const imageReferences = result.images.map((img, index) => {
  return imageStore.store(sessionId, img);
});

return createSuccessResponse({
  stdout,
  stderr,
  result: result.result,
  images: imageReferences,  // resource_uri 形式
  execution_time_ms: result.execution_time_ms,
});
```

#### 4. 結合テストの追加

`tests/integration/execute-code-images.test.ts` を作成：

- matplotlib でグラフ描画
- images 配列が返ることを確認
- resource_uri の形式を確認

### 技術的な考慮事項

1. **画像ストレージ方式**
   - シンプルにインメモリで保持
   - 本番環境でメモリ不足が懸念される場合は、将来的にファイルシステムやRedisに変更可能な設計に

2. **リソースURI形式**
   - 要件定義の形式: `jupyter://sessions/{session_id}/images/{image_id}.{ext}`
   - 例: `jupyter://sessions/abc123/images/output-001.png`

3. **description の生成**
   - `matplotlib output [N]` の形式
   - 実行順序に基づいて連番を付与

4. **メモリ管理**
   - セッション削除時に関連画像も削除
   - 将来的に TTL や最大保持数の制限を検討

## 完了条件

- [x] matplotlib でグラフを描画すると、execute_code の結果に images 配列が含まれる
- [x] images 配列の各要素に resource_uri, mime_type, description が含まれる
- [x] resource_uri は `jupyter://sessions/{session_id}/images/{image_id}.png` 形式
- [x] 画像データは ImageStore に保存され、後から取得可能
- [x] 結合テストが通る

## テスト計画

### 結合テスト

```typescript
test('matplotlib でグラフを描画すると images 配列が返る', async () => {
  // 1. セッション作成
  // 2. matplotlib コードを実行
  const code = `
import matplotlib.pyplot as plt
plt.figure(figsize=(8, 6))
plt.plot([1, 2, 3, 4], [1, 4, 2, 3])
plt.title('Test Plot')
plt.show()
`;
  // 3. images 配列を確認
  expect(images).toHaveLength(1);
  expect(images[0].resource_uri).toMatch(/^jupyter:\/\/sessions\/.+\/images\/.+\.png$/);
  expect(images[0].mime_type).toBe('image/png');
  expect(images[0].description).toContain('matplotlib');
});

test('複数のグラフを描画すると複数の画像が返る', async () => {
  // 複数の plt.show() で複数画像が返ることを確認
});

test('グラフなしのコードでは images が空配列', async () => {
  // print("hello") などでは images: []
});
```

### 手動テスト

1. docker-compose up でサーバー起動
2. MCP Inspector で execute_code を実行
3. matplotlib コードで画像が返ることを確認

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
