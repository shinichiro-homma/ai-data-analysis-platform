# タスク詳細: 6.1 file_list ツール実装

## 概要

ワークスペース内のファイル一覧を取得する MCP ツール `file_list` を実装する。

このツールにより、AI エージェントは Jupyter 環境内のファイル構造を把握でき、以下のようなユースケースに対応できる：
- ノートブック作成後にファイルの存在を確認する
- データファイルの一覧を取得して分析対象を特定する
- ディレクトリ構造を確認してファイル配置を理解する

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「F5: ファイル操作」セクション（F5.1 ファイル一覧）
- API仕様: `docs/design/api-contracts.md` の「GET /api/contents」セクション
- MCP SDK Skill: `.claude/skills/mcp-typescript-server/SKILL.md`

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/src/tools/file-list.ts` | file_list ツールの実装本体 |
| `jupyter-mcp/src/tools/index.ts` | ツール定義とルーティングの追加（既存ファイル修正） |

### 実装手順

1. **file-list.ts を新規作成**
   - 既存の `session-list.ts` を参考にした構造で実装
   - 入力パラメータ: `session_id`（必須）, `path`（オプション、デフォルト `/`）
   - `jupyterClient.listContents(path)` を使用して API 呼び出し

2. **入力検証の実装**
   - `session_id`: `validateStringParameter()` で検証
   - `path`: オプション。指定時は `normalizeNotebookPath()` で正規化
   - パストラバーサル攻撃対策（`..` を含むパスの拒否）

3. **レスポンス形成**
   - `ContentsListResponse` を MCP レスポンス形式に変換
   - `createSuccessResponse()` / `createErrorResponse()` を使用

4. **index.ts を修正**
   - `file_list` ツール定義を追加
   - `handleToolCall` にルーティングを追加
   - import 文を追加

### 技術的な考慮事項

**パスの正規化:**
- ルートディレクトリは `""` または `/` で指定可能
- 先頭の `/` は除去して正規化（Jupyter API の仕様に合わせる）
- 空文字列の場合はルートディレクトリとして扱う

**session_id の扱い:**
- 要件定義では `session_id` が必須となっているが、実際の `listContents` API はセッション不要
- 統一性のため引数として受け取るが、内部では使用しない（将来的な権限管理の可能性を考慮）
- 検証は行い、存在しない session_id でもエラーにはしない（ファイル一覧取得自体は可能）

**エラーハンドリング:**
- Jupyter API 接続エラー: `CONNECTION_ERROR`
- パス検証エラー: `VALIDATION_ERROR`
- 存在しないパス: API からのエラーをそのまま返す

## 完了条件

- [x] `file_list` ツールが MCP Inspector で表示される
- [x] ルートディレクトリのファイル一覧が取得できる
- [x] 指定ディレクトリのファイル一覧が取得できる
- [x] 存在しないパスを指定した場合に適切なエラーが返る
- [x] パストラバーサル攻撃（`..` を含むパス）が拒否される
- [x] ビルド（`npm run build`）が成功する
- [x] 型チェック（`npm run typecheck`）が成功する

## テスト計画

### 手動テスト（MCP Inspector）

1. **基本動作確認**
   ```
   # ルートディレクトリのファイル一覧
   file_list(session_id: "test-session")

   # 特定ディレクトリのファイル一覧
   file_list(session_id: "test-session", path: "data")
   ```

2. **エラーケース確認**
   ```
   # パストラバーサル攻撃
   file_list(session_id: "test", path: "../etc/passwd")
   → エラー: VALIDATION_ERROR

   # 存在しないパス
   file_list(session_id: "test", path: "nonexistent")
   → エラー: NOT_FOUND（API からのエラー）
   ```

### 結合テスト（タスク 6.2）

- ノートブック作成 → file_list で確認 の一連フロー

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
