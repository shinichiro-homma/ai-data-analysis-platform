# タスク詳細: 1.1.5 ヘルスチェックスクリプト作成

## 概要

jupyter-server の稼働状態を確認するためのヘルスチェックスクリプトを作成する。
このスクリプトは Docker のヘルスチェック機構や外部監視システムから呼び出され、Jupyter Server および Python カーネルの正常動作を確認する。

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-server.md` の「NF4: 運用性」セクション
  - 「ヘルスチェックエンドポイントを提供」
- API仕様: `docs/design/api-contracts.md` の「ヘルスチェック」セクション
  - `GET /health` エンドポイントの仕様

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-server/scripts/healthcheck.sh` | ヘルスチェックスクリプト本体 |

### 更新するファイル

| ファイル | 変更内容 |
|----------|----------|
| `jupyter-server/Dockerfile` | ヘルスチェックスクリプトのコピーとHEALTHCHECK命令を有効化 |
| `jupyter-server/docker-compose.yml` | healthcheck設定を追加 |

### 実装手順

1. **scripts ディレクトリ作成**
   - `jupyter-server/scripts/` ディレクトリを作成

2. **healthcheck.sh の実装**
   - Jupyter Server の API エンドポイントにリクエストを送信
   - `/api/kernels` への疎通確認（カーネル管理APIの稼働確認）
   - 認証トークンを使用した認証付きリクエスト
   - 適切な終了コード（0: 正常、1: 異常）を返却

3. **Dockerfile の更新**
   - healthcheck.sh をコンテナにコピー
   - 実行権限を付与
   - HEALTHCHECK 命令を追加

4. **docker-compose.yml の更新**
   - healthcheck 設定を追加（interval, timeout, retries, start_period）

### ヘルスチェックスクリプトの仕様

```bash
#!/bin/bash
# healthcheck.sh

# 環境変数から設定を取得
JUPYTER_URL="${JUPYTER_URL:-http://localhost:8888}"
JUPYTER_TOKEN="${JUPYTER_TOKEN:-}"

# Jupyter Server の カーネル管理API確認
response=$(curl -sf -H "Authorization: token ${JUPYTER_TOKEN}" \
  "${JUPYTER_URL}/api/kernels" 2>/dev/null)

if [ $? -eq 0 ]; then
  exit 0
else
  exit 1
fi
```

### Docker ヘルスチェック設定

```yaml
# docker-compose.yml
healthcheck:
  test: ["CMD", "/usr/local/bin/healthcheck.sh"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s
```

### 技術的な考慮事項

1. **起動時間への配慮**
   - Jupyter Server は起動に時間がかかるため、`start_period` を十分に確保する（60秒）
   - 起動直後のヘルスチェック失敗は許容する

2. **認証トークンの取り扱い**
   - 環境変数 `JUPYTER_TOKEN` から取得
   - トークンなしでもアクセス可能な設計の場合は、トークン省略に対応

3. **curl の使用**
   - `jupyter/scipy-notebook` イメージには curl が含まれている
   - `-s`（サイレント）と `-f`（エラー時に失敗）オプションを使用

4. **エンドポイント選定理由**
   - `/api/kernels` はカーネル管理機能の稼働も確認できる
   - カーネルが0個でも正常応答（空配列）を返すため問題なし

## 完了条件

- [x] `jupyter-server/scripts/healthcheck.sh` が作成されている
- [x] スクリプトに実行権限がある
- [x] `Dockerfile` にヘルスチェックスクリプトのコピー処理が追加されている
- [x] `Dockerfile` に HEALTHCHECK 命令が追加されている
- [x] `docker-compose.yml` に healthcheck 設定が追加されている
- [x] `docker-compose up` 後、`docker ps` で STATUS が "healthy" になる

## テスト計画

### 手動テスト

1. **正常系テスト**
   ```bash
   # コンテナをビルド・起動
   cd jupyter-server
   docker-compose up -d --build

   # ヘルスチェック状態を確認（healthy になるまで待機）
   docker ps
   # STATUS 列が "healthy" であることを確認

   # 直接スクリプトを実行して確認
   docker exec jupyter-server /usr/local/bin/healthcheck.sh && echo "OK" || echo "FAIL"
   ```

2. **異常系テスト**
   ```bash
   # Jupyter Server を停止した状態でヘルスチェック
   docker exec jupyter-server pkill -f jupyter
   # STATUS が "unhealthy" に変わることを確認
   ```

### チェックリスト

- [ ] コンテナ起動から1分以内に healthy になる
- [ ] Jupyter Server 停止時に unhealthy になる
- [ ] ヘルスチェックスクリプト単体で正しい終了コードを返す

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
