# タスク詳細: 8.2 MCP Inspector での動作確認

## 概要

MCP Inspector を使って jupyter-mcp サーバーの全ツール・リソースが正しく動作することを確認する。

Phase 1〜7 で実装した全 11 ツールと画像リソース（resources/list, resources/read）を、MCP Inspector の GUI 上で実際に実行し、期待する動作を検証する。

**ブラウザ操作は Playwright MCP を使用して自動実行する。** MCP Inspector の GUI 操作（ツール選択、パラメータ入力、実行ボタンクリック）およびカーネル共有テストでの JupyterLab 操作を Playwright MCP で行う。

このタスクが必要な理由:
- 単体テスト（タスク 8.1）はモックベースであり、実際の MCP プロトコル経由の疎通は未検証
- MCP Inspector は MCP クライアントとして標準的なプロトコルで接続するため、実環境に近いテストとなる
- 次のタスク 8.3（Claude Desktop 連携）の前提として、MCP プロトコルレベルの正常動作を担保する

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「MCPツール定義」「MCPリソース定義」「受け入れ条件 AC6」セクション
- 全体像: `docs/overview.md` の「提供するMCPツール」「MCPリソース」セクション
- Skill: `.claude/skills/mcp-typescript-server/SKILL.md` の「デバッグ > MCP Inspector での確認」セクション

## 前提条件

- jupyter-server が Docker で起動していること（`cd jupyter-server && docker-compose up -d`）
- jupyter-mcp がビルド済みであること（`cd jupyter-mcp && npm run build`）

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/docs/inspector-test-guide.md` | MCP Inspector テスト手順書 |

### 実装手順

#### ステップ 1: 環境準備

1. jupyter-server を起動する
   ```bash
   cd jupyter-server && docker-compose up -d
   ```

2. jupyter-mcp をビルドする
   ```bash
   cd jupyter-mcp && npm run build
   ```

3. MCP Inspector を起動する
   ```bash
   cd jupyter-mcp && npx @modelcontextprotocol/inspector \
     -e JUPYTER_SERVER_URL=http://localhost:8888 \
     -e JUPYTER_TOKEN=test-token-123 \
     node dist/index.js
   ```

4. Playwright MCP で Inspector UI（http://localhost:6274）を開く
   - `browser_navigate` で `http://localhost:6274` にアクセス
   - `browser_snapshot` で初期画面の状態を確認

#### ステップ 2: ツール一覧の確認

Playwright MCP で Inspector の「Tools」タブを操作し、以下 11 ツールが表示されることを確認する:

| # | ツール名 | 確認ポイント |
|---|----------|-------------|
| 1 | `notebook_create` | name パラメータが表示される |
| 2 | `notebook_add_cell` | notebook_path, cell_type, source, position パラメータが表示される |
| 3 | `session_create` | name, notebook_path パラメータが表示される |
| 4 | `session_list` | パラメータなし |
| 5 | `session_delete` | session_id パラメータ（required）が表示される |
| 6 | `session_connect` | notebook_path, kernel_id パラメータが表示される |
| 7 | `execute_code` | session_id, code, timeout パラメータが表示される |
| 8 | `get_variables` | session_id パラメータ（required）が表示される |
| 9 | `get_dataframe_info` | session_id, variable_name パラメータ（required）が表示される |
| 10 | `file_list` | session_id, path パラメータが表示される |
| 11 | `get_image_resource` | resource_uri パラメータ（required）が表示される |

#### ステップ 3: 基本フローの実行テスト

以下の順序で、Playwright MCP を使って Inspector GUI 上でツールを実行し、結果を確認する。
各ステップで `browser_snapshot` を使い、GUI の状態（入力フォーム、実行結果）を確認する。

**3-1. セッション作成**
- ツール: `session_create`
- 入力: `{}` （パラメータなし）
- 期待: `session_id`, `kernel_id` が返る

**3-2. セッション一覧**
- ツール: `session_list`
- 入力: `{}`
- 期待: 3-1 で作成したセッションが一覧に含まれる

**3-3. ノートブック作成**
- ツール: `notebook_create`
- 入力: `{ "name": "inspector-test" }`
- 期待: `path` に `inspector-test.ipynb` が含まれる

**3-4. セル追加**
- ツール: `notebook_add_cell`
- 入力: `{ "notebook_path": "inspector-test.ipynb", "cell_type": "code", "source": "print('hello from inspector')" }`
- 期待: セルが追加された旨のレスポンス

**3-5. コード実行**
- ツール: `execute_code`
- 入力: `{ "session_id": "<3-1のsession_id>", "code": "print('hello from inspector')" }`
- 期待: `success: true`, `stdout: "hello from inspector\n"`

**3-6. 変数定義 + 取得**
- ツール: `execute_code`
- 入力: `{ "session_id": "<session_id>", "code": "import pandas as pd\ndf = pd.DataFrame({'a': [1,2,3], 'b': [4,5,6]})\nx = 42" }`
- 期待: `success: true`
- ツール: `get_variables`
- 入力: `{ "session_id": "<session_id>" }`
- 期待: `df`, `x` が変数一覧に含まれる

**3-7. DataFrame 詳細**
- ツール: `get_dataframe_info`
- 入力: `{ "session_id": "<session_id>", "variable_name": "df" }`
- 期待: `shape: [3, 2]`, カラム情報、先頭行データ

**3-8. ファイル一覧**
- ツール: `file_list`
- 入力: `{ "session_id": "<session_id>" }`
- 期待: `inspector-test.ipynb` がファイル一覧に含まれる

**3-9. グラフ描画 + 画像取得**
- ツール: `execute_code`
- 入力:
  ```json
  {
    "session_id": "<session_id>",
    "code": "import matplotlib.pyplot as plt\nplt.figure()\nplt.plot([1,2,3],[4,5,6])\nplt.title('Inspector Test')\nplt.show()"
  }
  ```
- 期待: `success: true`, `images` 配列に `resource_uri` が含まれる
- ツール: `get_image_resource`
- 入力: `{ "resource_uri": "<上記のresource_uri>" }`
- 期待: `mime_type: "image/png"`, `data` にbase64文字列

**3-10. セッション削除**
- ツール: `session_delete`
- 入力: `{ "session_id": "<session_id>" }`
- 期待: 成功レスポンス
- ツール: `session_list`
- 入力: `{}`
- 期待: 削除したセッションが一覧に含まれない

#### ステップ 4: リソースの確認

Playwright MCP で Inspector の「Resources」タブに切り替えて操作する。

**4-1. リソース一覧**
- Playwright MCP で「Resources」タブをクリック
- `browser_snapshot` で `jupyter://sessions/...` 形式のリソースが表示されることを確認
  （ステップ 3-9 で画像を生成済みの場合）

**4-2. リソース読み取り**
- Playwright MCP でリソースを選択して Read を実行
- `browser_snapshot` で base64 エンコードされた画像データが返ることを確認

#### ステップ 5: エラーケースの確認

**5-1. 存在しないセッション**
- ツール: `execute_code`
- 入力: `{ "session_id": "nonexistent", "code": "print('test')" }`
- 期待: エラーメッセージが返る（クラッシュしない）

**5-2. タイムアウト**
- ツール: `execute_code`
- 入力: `{ "session_id": "<有効なsession_id>", "code": "import time; time.sleep(60)", "timeout": 3 }`
- 期待: タイムアウトエラーが返る

**5-3. Python エラー**
- ツール: `execute_code`
- 入力: `{ "session_id": "<session_id>", "code": "1/0" }`
- 期待: `success: false`, `error_type: "ZeroDivisionError"`

#### ステップ 6: カーネル共有の確認

Playwright MCP で JupyterLab にもアクセスして操作する。Inspector と JupyterLab を別タブで開く。

**6-1. notebook_path 指定でのセッション作成**
- Inspector タブで `session_create` を実行
- 入力: `{ "notebook_path": "shared-test.ipynb" }`
- 期待: セッション作成成功
- Playwright MCP で新しいタブを開き、JupyterLab（`http://localhost:8888/?token=test-token-123`）にアクセス
- `browser_snapshot` で JupyterLab の画面を確認
- `shared-test.ipynb` を開き、同じカーネルに接続されていることを確認

**6-2. session_connect**
- Playwright MCP で JupyterLab タブに切り替え
- JupyterLab 上で新規ノートブックを作成して開く
- Inspector タブに切り替え、`session_connect` を実行
- 入力: `{ "notebook_path": "<JupyterLabで開いたノートブックのパス>" }`
- 期待: 接続成功、`connected: true`

#### ステップ 7: テスト結果の記録とテスト手順書の作成

上記の確認内容と Playwright MCP で取得したスナップショットの結果をもとに、`jupyter-mcp/docs/inspector-test-guide.md` にテスト手順書を作成する。
再現可能な手順として整理し、将来のリグレッション確認にも使用できるようにする。

### 技術的な考慮事項

- **MCP Inspector の起動方法**: `npx @modelcontextprotocol/inspector` は STDIO トランスポートを使用し、MCP サーバーのプロセスを自動起動する。jupyter-mcp は STDIO ベースなので、追加設定なしで接続可能
- **環境変数の渡し方**: `-e` フラグで `JUPYTER_SERVER_URL` と `JUPYTER_TOKEN` を渡す必要がある
- **Inspector のポート**: デフォルトで UI が 6274、Proxy が 6277 で起動する
- **Playwright MCP の活用**: ブラウザ操作はすべて Playwright MCP（`browser_navigate`, `browser_snapshot`, `browser_click`, `browser_type`, `browser_fill_form`, `browser_tabs` 等）で実行する。Inspector GUI のツール選択・パラメータ入力・実行ボタンクリック・結果確認を自動化する
- **タブ管理**: Inspector（タブ1）と JupyterLab（タブ2）を `browser_tabs` で切り替えて操作する
- **テスト順序**: セッション作成 → コード実行 → 変数確認 → 画像生成 → セッション削除の順で依存関係に従う
- **クリーンアップ**: テスト後はセッションを削除する。テスト用ノートブックは session_delete 時に自動クリーンアップされるか、残っても問題ない

## 完了条件

- [ ] MCP Inspector が起動し、jupyter-mcp に接続できる
- [ ] 全 11 ツールが Inspector の Tools タブに表示される
- [ ] 各ツールの inputSchema（パラメータ、required）が正しく表示される
- [ ] session_create / session_list / session_delete が正常動作する
- [ ] session_connect でブラウザのセッションに接続できる
- [ ] notebook_create / notebook_add_cell が正常動作する
- [ ] execute_code で Python コードが実行でき、結果が返る
- [ ] execute_code でのエラー・タイムアウトが適切にハンドリングされる
- [ ] get_variables / get_dataframe_info が正常動作する
- [ ] file_list が正常動作する
- [ ] execute_code でグラフ描画時に images 配列に resource_uri が返る
- [ ] get_image_resource で画像データ（base64）が取得できる
- [ ] Resources タブで画像リソースの一覧・取得ができる
- [ ] テスト手順書（inspector-test-guide.md）が作成されている

## テスト計画

このタスク自体が手動テストのタスクである。テスト方法は上記「実装手順」に記載の通り。

不具合が発見された場合は、修正してから再テストする。

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
