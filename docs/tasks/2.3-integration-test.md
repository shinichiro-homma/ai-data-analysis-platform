# タスク詳細: 2.3 結合テスト

## 概要

Phase 2 で実装した `notebook_create` と `notebook_add_cell` ツールの結合テストを実施する。

**目的:**
- ノートブック作成→セル追加の一連フローが正しく動作することを確認
- 自動テストの基盤を整備し、CI/CD での回帰テストを可能にする
- E2E テストスクリプトを作成し、手動確認の負担を軽減

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「F3.1: ノートブック作成」「F3.2: セル操作」
- API仕様: `docs/design/api-contracts.md` の「POST /api/contents」「PATCH /api/contents/{path}/cells」
- 前提タスク: `docs/tasks/2.1-notebook-create.md`, `docs/tasks/2.2-notebook-add-cell.md`

## 実装計画

### 作成するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/tests/integration/notebook.test.ts` | ノートブック操作の結合テスト |
| `jupyter-mcp/tests/setup.ts` | テストのセットアップ（JupyterClient モック設定等） |
| `jupyter-mcp/vitest.config.ts` | Vitest 設定ファイル |

### 修正するファイル

| ファイル | 変更内容 |
|----------|----------|
| `jupyter-mcp/package.json` | テスト用依存関係と scripts の追加 |
| `jupyter-mcp/tsconfig.json` | tests ディレクトリの include 追加（必要な場合） |

### 実装手順

1. **テスト環境のセットアップ**
   - Vitest のインストール（TypeScript 対応、ESM 対応）
   - `package.json` に `test`, `test:integration` スクリプトを追加
   - `vitest.config.ts` の作成

2. **テストユーティリティの作成** (`tests/setup.ts`)
   - テスト用の JupyterClient 設定（実際の jupyter-server に接続）
   - テスト前後のクリーンアップ関数
   - 共通のアサーション関数

3. **結合テストの実装** (`tests/integration/notebook.test.ts`)
   - テストケース 1: ノートブック作成→code セル追加
   - テストケース 2: ノートブック作成→markdown セル追加
   - テストケース 3: ノートブック作成→複数セル追加→内容確認
   - テストケース 4: position 指定でのセル挿入

4. **テスト実行スクリプトの追加**
   - `npm test` で単体テスト（モック使用）
   - `npm run test:integration` で結合テスト（実環境使用）

### 技術的な考慮事項

#### テストフレームワーク

Vitest を採用する理由：
- TypeScript / ESM ネイティブサポート
- Jest 互換の API で学習コストが低い
- 高速な実行
- `@modelcontextprotocol/sdk` のサンプルでも使用例あり

#### 結合テスト vs 単体テスト

| 種類 | 対象 | 外部依存 | 実行タイミング |
|------|------|----------|----------------|
| 単体テスト | 各ツールのロジック | モック | CI で常時 |
| 結合テスト | MCP ツール → Jupyter API の全フロー | 実 jupyter-server | 手動 / CI (Docker) |

今回は結合テストを優先し、実際の jupyter-server に対してテストを実行する。
これにより、API 仕様との整合性も同時に確認できる。

#### テスト用ノートブックのクリーンアップ

- 各テスト実行前に、テスト用ノートブックを削除（存在する場合）
- テスト名に基づいたユニークなノートブック名を使用（`test-{timestamp}.ipynb`）
- `afterEach` / `afterAll` でクリーンアップ

#### 結合テストの前提条件

- jupyter-server が起動していること
- 環境変数 `JUPYTER_SERVER_URL`, `JUPYTER_TOKEN` が設定されていること

### テストケース詳細

#### Test 1: ノートブック作成→code セル追加

```typescript
test('ノートブックを作成し、code セルを追加できる', async () => {
  // 1. ノートブック作成
  const createResult = await handleToolCall('notebook_create', {
    name: 'test-integration-1',
  });

  // 2. 作成成功を確認
  expect(createResult.success).toBe(true);
  expect(createResult.path).toBe('test-integration-1.ipynb');

  // 3. code セルを追加
  const addCellResult = await handleToolCall('notebook_add_cell', {
    notebook_path: 'test-integration-1.ipynb',
    cell_type: 'code',
    source: 'print("Hello from integration test")',
  });

  // 4. 追加成功を確認
  expect(addCellResult.success).toBe(true);

  // 5. ノートブックの内容を取得して検証
  const notebook = await jupyterClient.getContents('test-integration-1.ipynb');
  expect(notebook.content.cells.length).toBeGreaterThan(0);
  expect(notebook.content.cells[notebook.content.cells.length - 1].source).toContain('Hello');
});
```

#### Test 2: 複数セル追加と position 指定

```typescript
test('複数のセルを追加し、position 指定で先頭に挿入できる', async () => {
  // 1. ノートブック作成
  await handleToolCall('notebook_create', { name: 'test-integration-2' });

  // 2. 末尾に 2 つセルを追加
  await handleToolCall('notebook_add_cell', {
    notebook_path: 'test-integration-2.ipynb',
    cell_type: 'code',
    source: 'first_cell = 1',
  });
  await handleToolCall('notebook_add_cell', {
    notebook_path: 'test-integration-2.ipynb',
    cell_type: 'code',
    source: 'second_cell = 2',
  });

  // 3. position=0 で先頭に挿入
  await handleToolCall('notebook_add_cell', {
    notebook_path: 'test-integration-2.ipynb',
    cell_type: 'markdown',
    source: '# Title',
    position: 0,
  });

  // 4. セルの順序を確認
  const notebook = await jupyterClient.getContents('test-integration-2.ipynb');
  expect(notebook.content.cells[0].cell_type).toBe('markdown');
  expect(notebook.content.cells[0].source[0]).toBe('# Title');
});
```

## 完了条件

- [x] `npm install` で Vitest と関連パッケージがインストールされる
- [x] `npm run test:integration` で結合テストが実行できる
- [x] ノートブック作成→セル追加の一連フローがテストで確認できる
- [x] 複数セル追加とposition指定がテストで確認できる
- [x] テスト後にテスト用ノートブックがクリーンアップされる
- [x] テスト結果のレポートが出力される

## テスト計画

### 事前準備

```bash
# 1. jupyter-server を起動
docker-compose up -d

# 2. 環境変数を設定（.env ファイルまたは export）
export JUPYTER_SERVER_URL=http://localhost:8888
export JUPYTER_TOKEN=dev-token

# 3. 依存関係インストール
cd jupyter-mcp && npm install
```

### テスト実行

```bash
# 結合テストの実行
npm run test:integration

# 特定のテストのみ実行
npm run test:integration -- --grep "ノートブックを作成"

# カバレッジレポート付きで実行
npm run test:integration -- --coverage
```

### テスト結果の確認

1. コンソール出力でテスト結果を確認
2. 失敗した場合はエラーメッセージを確認
3. 必要に応じて JupyterLab でノートブックの内容を確認

---

## レビューステータス

- [x] 計画レビュー完了
- [x] 実装完了
- [x] テスト完了
