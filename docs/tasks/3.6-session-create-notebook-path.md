# タスク詳細: 3.6 session_create の notebook_path 対応

## 概要

`session_create` ツールに `notebook_path` パラメータの実装を追加し、指定したノートブックに関連付けたセッションを作成できるようにする。

これにより**AI先行パターン**（AIがセッションを作成し、ユーザーが後からブラウザでそのノートブックを開いて同じカーネルを共有する）が可能になる。

### ユースケース

1. ユーザーがAI（MCP経由）に「sales_analysis.ipynb でデータ分析を始めて」と依頼
2. AIが `session_create(notebook_path="sales_analysis.ipynb")` でセッション作成
3. AIがコードを実行してデータを読み込み、変数 `df` を作成
4. ユーザーがブラウザで `sales_analysis.ipynb` を開く
5. ブラウザがAIと同じカーネルに自動的に接続
6. ユーザーが同じ `df` 変数にアクセスして手動で分析を継続できる

### 背景: タスク 3.5 との関係

- **タスク 3.5（session_connect）**: ユーザー先行パターン - ブラウザで開いたセッションにAIが接続
- **タスク 3.6（session_create with notebook_path）**: AI先行パターン - AIが作成したセッションにブラウザが接続

## 関連ドキュメント

- 要件定義: `docs/requirements/jupyter-mcp.md` の「F1.5: ノートブック指定でのセッション作成」セクション
- API仕様: `docs/design/api-contracts.md` の「カーネル管理」「ノートブック管理」セクション
- MCP実装パターン: `.claude/skills/mcp-typescript-server/SKILL.md`
- 既存実装: `jupyter-mcp/src/tools/session-create.ts`（現在は警告のみ）

## 実装計画

### 現状の確認

現在の `session_create.ts` では `notebook_path` パラメータを受け取るが、警告を出すのみで実際の処理は行わない:

```typescript
// notebook_path パラメータの警告（タスク 3.6 で実装予定）
console.warn(
  `[session_create] notebook_path パラメータは現在未実装です（タスク 3.6 で対応予定）: ${notebook_path}`
);
```

### Jupyter Server のセッションAPI

ブラウザでノートブックを開くと、Jupyter Server の `/api/sessions` にセッションが作成される。このAPIを使って、MCPからもセッションを作成できる。

**POST /api/sessions** のリクエスト形式（Jupyter Server 標準API）:
```json
{
  "name": "analysis.ipynb",
  "path": "analysis.ipynb",
  "type": "notebook",
  "kernel": {
    "name": "python3"
  }
}
```

**レスポンス形式**:
```json
{
  "id": "session-abc123",
  "path": "analysis.ipynb",
  "name": "analysis.ipynb",
  "type": "notebook",
  "kernel": {
    "id": "kernel-xyz789",
    "name": "python3",
    "last_activity": "2024-01-15T10:00:00Z",
    "execution_state": "idle",
    "connections": 1
  }
}
```

### 作成・変更するファイル

| ファイル | 内容 |
|----------|------|
| `jupyter-mcp/src/jupyter-client/client.ts` | `createSession(path, kernelName)` メソッド追加 |
| `jupyter-mcp/src/jupyter-client/types.ts` | `CreateSessionRequest` 型追加 |
| `jupyter-mcp/src/tools/session-create.ts` | `notebook_path` 対応の実装 |
| `jupyter-mcp/src/tools/index.ts` | ツール定義の description 更新（「現在未実装」を削除） |
| `jupyter-mcp/tests/integration/session-create-notebook-path.test.ts` | 結合テスト |

### 実装手順

#### 1. CreateSessionRequest 型定義の追加

`jupyter-mcp/src/jupyter-client/types.ts` に追加:

```typescript
// セッション作成リクエスト
export interface CreateSessionRequest {
  name: string;        // ノートブック名
  path: string;        // ノートブックパス
  type: 'notebook';
  kernel: {
    name: string;      // カーネル名（例: "python3"）
  };
}
```

#### 2. JupyterClient に createSession メソッド追加

`jupyter-mcp/src/jupyter-client/client.ts` に追加:

```typescript
/**
 * セッションを作成する（ノートブックとカーネルを関連付け）
 * 注意: /api/sessions は標準APIなので ApiResponse ラッパーなし
 */
async createSession(notebookPath: string, kernelName = 'python3'): Promise<JupyterSession> {
  // パス正規化: 先頭の '/' を除去
  const normalizedPath = notebookPath.replace(/^\//, '');
  // ファイル名を抽出
  const name = normalizedPath.split('/').pop() ?? normalizedPath;

  const body: CreateSessionRequest = {
    name,
    path: normalizedPath,
    type: 'notebook',
    kernel: { name: kernelName },
  };

  const response = await this.request<JupyterSession>('POST', '/api/sessions', body);
  return response;
}
```

#### 3. session_create ツールの更新

`jupyter-mcp/src/tools/session-create.ts` を更新:

```typescript
export async function executeSessionCreate(
  args: Record<string, unknown>
): Promise<McpResponse> {
  const { name = "python3", notebook_path } = args as SessionCreateArgs;

  // 入力検証は既存のまま...

  try {
    if (notebook_path) {
      // notebook_path が指定された場合: セッション（ノートブック+カーネル）を作成
      const session = await jupyterClient.createSession(notebook_path, name);

      return createSuccessResponse({
        session_id: session.id,
        kernel_id: session.kernel.id,
        notebook_path: session.path,
        status: session.kernel.execution_state,
        created_at: session.kernel.last_activity,
      });
    } else {
      // notebook_path が指定されない場合: カーネルのみ作成（既存動作）
      const kernel = await jupyterClient.createKernel(name);
      const sessionInfo = kernelToSessionInfo(kernel, false);
      return createSuccessResponse({ ...sessionInfo });
    }
  } catch (error) {
    return createErrorResponse(
      extractErrorMessage(error),
      extractErrorCode(error)
    );
  }
}
```

#### 4. ツール定義の更新

`jupyter-mcp/src/tools/index.ts` の `session_create` 定義を更新:

```typescript
{
  name: "session_create",
  description: "新しいデータ分析セッションを作成します。コード実行前に必ず呼び出してください。",
  inputSchema: {
    type: "object",
    properties: {
      name: {
        type: "string",
        description: "カーネル名（デフォルト: python3）",
      },
      notebook_path: {
        type: "string",
        description: "関連付けるノートブックのパス。指定するとユーザーがそのノートブックを開いたときに同じカーネルを共有できる",
      },
    },
    required: [],
  },
},
```

#### 5. 結合テスト作成

`jupyter-mcp/tests/integration/session-create-notebook-path.test.ts` を新規作成。

### 技術的な考慮事項

#### 1. ノートブックの存在確認

- Jupyter Server の `/api/sessions` はノートブックが存在しなくても（空のノートブックとして）セッションを作成する
- ただし、ノートブックファイル自体は自動作成されない場合がある
- 既存のノートブックがある場合は、そのノートブックに関連付けられる

#### 2. 既存セッションとの競合

- 同じ `notebook_path` で既にセッションが存在する場合、Jupyter Server は新しいセッションを作成せず、既存セッションを返す可能性がある
- この動作はJupyter Server のバージョンや設定による
- 結合テストで実際の動作を確認する

#### 3. パス正規化

- `/analysis.ipynb` と `analysis.ipynb` は同一として扱う
- サブディレクトリも対応: `data/analysis.ipynb`

#### 4. レスポンス形式の統一

- `notebook_path` 指定時と非指定時で、できるだけ近いレスポンス形式を返す
- 主な違い: `notebook_path` 指定時は `notebook_path` フィールドが追加される

## 完了条件

- [ ] `session_create(notebook_path="analysis.ipynb")` でセッションが作成される
- [ ] 作成されたセッションの情報（session_id, kernel_id, notebook_path, status）が返される
- [ ] ブラウザで同じノートブックを開くと、同じカーネルに接続される
- [ ] `notebook_path` を指定しない場合は従来通りカーネルのみ作成される
- [ ] 入力バリデーションが機能する
- [ ] 結合テストが通る
- [ ] ツール定義の「現在未実装」が削除されている

## テスト計画

### 結合テスト（実際の Jupyter Server を使用）

1. **正常系: notebook_path 指定でセッション作成**
   - `session_create(notebook_path="test.ipynb")` を実行
   - session_id, kernel_id, notebook_path が返されることを確認
   - `session_list` で作成したセッションが表示されることを確認

2. **正常系: 作成したセッションに session_connect で接続**
   - `session_create(notebook_path="test.ipynb")` でセッション作成
   - `session_connect(notebook_path="test.ipynb")` で接続
   - 同じ kernel_id が返されることを確認

3. **正常系: notebook_path なしの従来動作**
   - `session_create()` を実行
   - カーネルのみ作成されることを確認（notebook_path なし）

4. **異常系: 無効なパス**
   - 空文字、長すぎるパスでエラーを確認

### 手動テスト

1. **ブラウザとの連携確認**
   - `session_create(notebook_path="manual_test.ipynb")` でセッション作成
   - MCPツールでコードを実行: `x = 42`
   - ブラウザで `manual_test.ipynb` を開く
   - ブラウザで `print(x)` を実行し、`42` が表示されることを確認

---

## レビューステータス

- [x] 計画レビュー完了
- [ ] 実装完了
- [ ] テスト完了
