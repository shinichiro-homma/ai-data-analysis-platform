# jupyter-server 要件定義

## 概要

JupyterLabをベースとしたデータ分析実行環境。生成AIからのコード実行リクエストを受け付け、結果を返却する。

## 機能要件

### F1: カーネル管理

#### F1.1: カーネル起動
- Pythonカーネルを起動できる
- 複数カーネルの同時起動をサポート（最大5つ）
- カーネルごとに独立した名前空間を持つ

#### F1.2: カーネル停止
- 指定したカーネルを停止できる
- 全カーネルの一括停止ができる

#### F1.3: カーネル状態確認
- カーネルの状態（idle/busy/dead）を取得できる
- 起動中のカーネル一覧を取得できる

### F2: コード実行

#### F2.1: コード実行
- 任意のPythonコードを実行できる
- 実行結果（stdout, stderr, 戻り値）を取得できる
- 画像出力（matplotlib等）をbase64形式で取得できる

#### F2.2: 実行制御
- 実行中のコードを中断できる
- タイムアウト設定が可能（デフォルト30秒、最大300秒）

#### F2.3: 変数管理
- カーネル内の定義済み変数一覧を取得できる
- 変数の値を取得できる（JSONシリアライズ可能なもの）
- DataFrameの場合、shape/columns/dtypes/head を取得できる

### F3: ノートブック管理

#### F3.1: ノートブック作成
- 新規ノートブックを作成できる
- 指定した名前で保存できる

#### F3.2: ノートブック読み込み
- 既存のノートブックを開ける
- セル一覧を取得できる

#### F3.3: セル操作
- セルの追加/編集/削除ができる
- セルの実行ができる
- セルの出力を取得できる

### F4: ファイル管理

#### F4.1: データファイルアクセス
- 指定ディレクトリ内のファイル一覧を取得できる
- CSVなどのデータファイルを読み込める

#### F4.2: 出力ファイル管理
- 分析結果をファイルとして保存できる
- 保存したファイルをダウンロードできる

## 非機能要件

### NF1: パフォーマンス

| 項目 | 要件 |
|------|------|
| カーネル起動時間 | 10秒以内 |
| コード実行開始 | リクエストから1秒以内 |
| 同時実行カーネル数 | 最大5 |
| 最大出力サイズ | 1MB/実行 |

### NF2: セキュリティ

- 信頼されたネットワーク内でのみ動作を想定
- ファイルアクセスは指定ディレクトリ内に制限
- 危険なシステムコール（os.system等）の実行は許可するが、ログを記録

### NF3: 可用性

- カーネルクラッシュ時、自動的に新しいカーネルを起動可能
- 長時間アイドル状態のカーネルは自動シャットダウン（30分）

### NF4: 運用性

- Dockerコンテナとしてデプロイ
- 環境変数で設定を変更可能
- ヘルスチェックエンドポイントを提供

## 技術仕様

### ベースイメージ

```dockerfile
FROM jupyter/scipy-notebook:python-3.11
```

### プリインストールライブラリ

```
# データ処理
pandas>=2.0
numpy>=1.24
polars>=0.20

# 可視化
matplotlib>=3.7
seaborn>=0.12
plotly>=5.18

# データベース接続
sqlalchemy>=2.0
psycopg2-binary
pymysql

# ユーティリティ
requests
python-dotenv
```

### 公開API

Jupyter Server標準のREST APIを使用:

| エンドポイント | 用途 |
|---------------|------|
| `GET /api/kernels` | カーネル一覧 |
| `POST /api/kernels` | カーネル起動 |
| `DELETE /api/kernels/{id}` | カーネル停止 |
| `POST /api/kernels/{id}/execute` | コード実行 |
| `GET /api/contents` | ファイル一覧 |
| `GET /api/contents/{path}` | ファイル取得 |

※ 一部カスタム拡張が必要な場合あり

### ポート

- 8888: JupyterLab UI / REST API

### 環境変数

| 変数名 | 説明 | デフォルト |
|--------|------|-----------|
| `JUPYTER_TOKEN` | 認証トークン | （必須） |
| `KERNEL_TIMEOUT` | カーネルアイドルタイムアウト（秒） | 1800 |
| `EXECUTION_TIMEOUT` | コード実行タイムアウト（秒） | 30 |
| `MAX_OUTPUT_SIZE` | 最大出力サイズ（バイト） | 1048576 |
| `DATA_DIR` | データファイル配置ディレクトリ | /home/jovyan/data |
| `OUTPUT_DIR` | 出力ファイル配置ディレクトリ | /home/jovyan/output |

## ディレクトリ構成

```
jupyter-server/
├── CLAUDE.md
├── Dockerfile
├── docker-compose.yml
├── requirements.txt
├── jupyter_config/
│   └── jupyter_server_config.py
├── extensions/           # カスタム拡張（必要な場合）
│   └── custom_handlers.py
└── scripts/
    └── healthcheck.sh
```

## 受け入れ条件

### AC1: カーネル管理
- [ ] カーネルを起動し、状態が「idle」になることを確認
- [ ] 複数カーネルを同時に起動できる
- [ ] カーネルを停止し、一覧から消えることを確認

### AC2: コード実行
- [ ] `print("hello")` を実行し、stdout に "hello" が返る
- [ ] `1/0` を実行し、ZeroDivisionError がstderrに返る
- [ ] matplotlibでグラフを描画し、base64画像が返る
- [ ] 30秒以上かかるコードがタイムアウトする

### AC3: 変数管理
- [ ] `x = 42` 実行後、変数一覧に `x` が含まれる
- [ ] DataFrameを作成し、schema情報が取得できる

### AC4: ノートブック
- [ ] 新規ノートブックを作成できる
- [ ] セルを追加・実行・削除できる
- [ ] ノートブックを保存・再読み込みできる

## 依存関係

- なし（最初に開発するコンポーネント）

## 次フェーズへの入力

このコンポーネントが提供するAPIを、jupyter-mcp が利用する。
