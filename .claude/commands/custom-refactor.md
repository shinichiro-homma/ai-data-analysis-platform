直近で実装したコードをリファクタリングします。

以下の手順で作業してください：

## 1. 対象ファイルの特定

直近のタスクで作成・変更したファイルを確認してください。

```bash
git diff --name-only HEAD~1
```

または、現在作業中のコンポーネントのソースファイルを対象としてください。

## 2. リファクタリング観点でのレビュー

以下の観点で各ファイルをレビューしてください：

### 2.1 コードの重複排除（優先度: 高）

- [ ] 同じ処理が複数箇所に存在しないか
- [ ] 共通化できるロジックはないか
- [ ] ユーティリティ関数として抽出すべき処理はないか

**対応:** 重複を見つけたら、共通関数/モジュールに抽出する

### 2.2 命名の改善（優先度: 高）

- [ ] 変数名が意図を正確に表しているか
- [ ] 関数名が処理内容を表しているか
- [ ] 省略しすぎて分かりにくい名前はないか
- [ ] 一貫した命名規則に従っているか

**命名規則:**
- TypeScript: camelCase（変数・関数）、PascalCase（クラス・型）
- Python: snake_case（変数・関数）、PascalCase（クラス）

### 2.3 エラーハンドリングの統一（優先度: 高）

- [ ] try-catch が適切に使われているか
- [ ] エラーメッセージが分かりやすいか
- [ ] エラーの種類に応じた処理がされているか
- [ ] エラーが握りつぶされていないか

**対応:** エラーハンドリングのパターンを統一する

### 2.4 セキュリティ（優先度: 高）

- [ ] 入力検証が適切に行われているか
- [ ] SQLインジェクション対策がされているか（パラメータ化クエリ）
- [ ] 機密情報がログやレスポンスに含まれていないか
- [ ] 認証・認可のチェックが漏れていないか
- [ ] タイムアウトが設定されているか（コード実行）
- [ ] パストラバーサル対策がされているか（ファイル操作）

**対応:** `.claude/rules/security.md` のルールに従って修正する

### 2.5 責務の分離（優先度: 中）

- [ ] 1つの関数が複数のことをしていないか（単一責任原則）
- [ ] 1つのファイルが大きすぎないか（目安: 200行以上は分割検討）
- [ ] 関連する処理が適切にグループ化されているか

**対応:** 大きな関数は分割、大きなファイルはモジュール分割

### 2.6 型定義の整理（優先度: 中）

- [ ] 型が明示的に定義されているか（any を使っていないか）
- [ ] 共通の型定義が types.ts / models.py にまとまっているか
- [ ] 不要な型定義がないか

## 3. リファクタリングの実施

問題を見つけたら、以下の順序で修正してください：

1. **セキュリティ** - 脆弱性の修正（最優先）
2. **コードの重複排除** - 共通関数の抽出
3. **責務の分離** - ファイル/関数の分割
4. **命名の改善** - 変数名・関数名の変更
5. **エラーハンドリングの統一** - パターンの適用
6. **型定義の整理** - 型の追加・整理

**注意:** 各修正は小さく行い、動作確認しながら進めてください。

## 4. 動作確認（必須）

リファクタリング後、以下のテストを**すべて実行**してください。テストが全てパスするまで次のステップに進まないでください。

### 4.1 対象コンポーネントの特定

リファクタリングしたファイルのパスから対象コンポーネントを判定：

| パス | コンポーネント |
|------|---------------|
| `jupyter-mcp/` | jupyter-mcp |
| `document-mcp/` | document-mcp |
| `document-server/` | document-server |
| `jupyter-server/` | jupyter-server |

### 4.2 コンポーネント全体のテスト実行

対象コンポーネントのディレクトリで、テストスイート全体を実行してください。

**TypeScript コンポーネント（jupyter-mcp, document-mcp, document-server）:**

```bash
cd {コンポーネントディレクトリ}
npm run typecheck
npm test
```

**Python コンポーネント（jupyter-server）:**

```bash
cd jupyter-server
mypy src/
pytest
```

### 4.3 進行中タスクのテスト計画実行

`docs/PLAN.md` を確認し、ステータスが `[→]` のタスクがあれば：

1. そのタスクの計画ファイル（`docs/tasks/{タスク番号}-*.md`）を開く
2. 「テスト計画」セクションを確認
3. 記載されているテスト（E2E手順、エラーケース確認など）を実行

**注意:** 進行中タスクがない場合は、4.2のテストのみで問題ありません。

### 4.4 テスト失敗時の対応

テストが失敗した場合：
1. エラー内容を確認する
2. リファクタリングによって導入された問題を修正する
3. 再度テストを実行する
4. **全てのテストがパスするまで繰り返す**

テストが全てパスしたことを確認してから、次のステップに進んでください。

## 5. 完了報告

以下の形式で報告してください：

```
## リファクタリング完了

### 対象ファイル
- path/to/file1.ts
- path/to/file2.ts

### 実施した改善

#### セキュリティ
- ユーザー入力の検証を追加
- SQLクエリをパラメータ化

#### コードの重複排除
- `fetchData` 関数を `utils/api.ts` に抽出

#### 命名の改善
- `data` → `userSessions`（意図を明確化）
- `proc` → `processExecutionResult`（省略を解消）

#### エラーハンドリングの統一
- API呼び出しに統一的な try-catch パターンを適用

#### 責務の分離
- `session.ts`（300行）を `session-manager.ts` と `session-utils.ts` に分割

#### 型定義の整理
- `any` を `ExecutionResult` 型に置き換え

### 動作確認
- typecheck: ✓ パス
- test: ✓ パス
```

## 6. コミット

リファクタリングが完了したら、コミットしてください：

```bash
git add .
git commit -m "refactor: {対象コンポーネント}のコード改善"
```
